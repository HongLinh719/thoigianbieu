<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Thời gian biểu cho bé</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<style>
        :root {
            --primary-color: #FF7043;
            --secondary-color: #FFAB91;
            --neutral-color: #FBE9E7;
            --text-color: #3E2723;
            --light-text: #795548;
            --success-color: #66BB6A;
            --warning-color: #FFCA28;
            --danger-color: #EF5350;
        }
        
        body {
            font-family: 'Baloo 2', cursive;
            margin: 0;
            padding: 0;
            background-color: var(--neutral-color);
            color: var(--text-color);
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
        }
        
        .date-container {
            background-color: white;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .date-display {
            font-size: 18px;
            font-weight: 600;
        }
        
        .date-nav {
            display: flex;
            gap: 15px;
        }
        
        .date-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .progress {
            height: 30px;
            background-color: white;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            text-align: center;
            line-height: 30px;
            color: white;
            font-weight: 600;
            transition: width 0.5s;
        }
        
        .task-list {
            margin-bottom: 20px;
        }
        
        .task {
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .task.completed-good {
            border-left: 5px solid var(--success-color);
        }
        
        .task.completed-neutral {
            border-left: 5px solid var(--warning-color);
        }
        
        .task.completed-bad {
            border-left: 5px solid var(--danger-color);
        }
        
        .task-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .task-time {
            background-color: var(--neutral-color);
            padding: 5px 10px;
            border-radius: 8px;
            font-weight: 600;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .task-name {
            font-weight: 600;
            font-size: 16px;
            flex-grow: 1;
        }
        
        .rating-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .rating-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Baloo 2', cursive;
            font-weight: 600;
            font-size: 16px; /* Tăng kích thước chữ */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .rating-btn i {
            font-size: 24px; /* Tăng kích thước icon */
        }
        
        .good-btn {
            background-color: #E8F5E9;
            color: var(--success-color);
        }
        
        .good-btn:hover, .good-btn.active {
            background-color: var(--success-color);
            color: white;
        }
        
        .neutral-btn {
            background-color: #FFF8E1;
            color: var(--warning-color);
        }
        
        .neutral-btn:hover, .neutral-btn.active {
            background-color: var(--warning-color);
            color: white;
        }
        
        .bad-btn {
            background-color: #FFEBEE;
            color: var(--danger-color);
        }
        
        .bad-btn:hover, .bad-btn.active {
            background-color: var(--danger-color);
            color: white;
        }
        
        .reward {
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #FFD54F, #FFCA28);
            border-radius: 12px;
            margin-top: 20px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }
        
        .reward.active {
            display: block;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            animation: slideDown 0.5s;
        }
        
        @keyframes slideDown {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
        
        .stats-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .stats-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .stats-modal.active {
            visibility: visible;
            opacity: 1;
        }
        
        .stats-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .stats-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--light-text);
        }
        
        .stats-chart {
            height: 200px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        
        .chart-bar {
            flex: 1;
            background-color: var(--primary-color);
            transition: height 0.5s;
            border-radius: 5px 5px 0 0;
            position: relative;
            min-width: 30px;
        }
        
        .chart-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            white-space: nowrap;
        }
        
        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: 600;
        }
        
        .stats-summary {
            margin-top: 40px;
            background-color: var(--neutral-color);
            padding: 15px;
            border-radius: 10px;
        }
        
        .sleep-record {
            display: flex;
            justify-content: space-between;
            background-color: #E8F5E9;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .sleep-record.good {
            background-color: #E8F5E9;
            border-left: 4px solid var(--success-color);
        }
        
        .sleep-record.neutral {
            background-color: #FFF8E1;
            border-left: 4px solid var(--warning-color);
        }
        
        .sleep-record.bad {
            background-color: #FFEBEE;
            border-left: 4px solid var(--danger-color);
        }
    /* Responsive design cho điện thoại */
    @media screen and (max-width: 768px) {
        body {
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 10px;
            margin: 0;
        }

        /* Điều chỉnh header */
        .header {
            margin: 0 0 15px 0;
            border-radius: 0;
        }

        .header h1 {
            font-size: 20px;
        }

        /* Điều chỉnh profile */
        div[style*="position: fixed; left: 20px; top: 100px;"] {
            position: static !important;
            width: 100% !important;
            margin: 10px 0;
            display: flex;
            justify-content: center;
        }

        #tridung-profile, #thaoVy-profile {
            margin: 0 !important;
            text-align: center;
        }

        #tridung-profile img, #thaoVy-profile img {
            width: 80px !important;
            height: 80px !important;
        }

        /* Điều chỉnh cây và nút tưới nước */
        div[style*="position: fixed; bottom: 500px; right: 340px;"] {
            position: static !important;
            width: 100% !important;
            margin: 10px 0;
            text-align: center;
        }

        #tree-img {
            width: 120px !important;
            height: 120px !important;
        }

        /* Điều chỉnh huy hiệu */
        div[style*="position: fixed; top: 100px; right: 20px;"] {
            position: static !important;
            width: 100% !important;
            margin: 10px 0;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Điều chỉnh tabs */
        .tabs {
            margin: 10px 0;
        }

        .tab {
            padding: 8px;
            font-size: 14px;
        }

        .tab img {
            width: 20px;
            height: 20px;
        }

        /* Điều chỉnh nhiệm vụ */
        .task {
            margin-bottom: 10px;
        }

        .task-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .task-time {
            margin-bottom: 5px;
            width: 100%;
            text-align: left;
        }

        .task-name {
            width: 100%;
        }

        .rating-buttons {
            flex-direction: column;
            gap: 5px;
        }

        .rating-btn {
            width: 100%;
            padding: 12px;
            justify-content: center;
        }

        /* Điều chỉnh hiệu ứng tưới nước */
        #watering-gif {
            width: 80px !important;
            height: auto !important;
            top: auto !important;
            left: 50% !important;
            transform: translateX(-50%);
            z-index: 1000;
        }

        /* Điều chỉnh popup chúc mừng */
        #popup-congrats {
            width: 90% !important;
            max-width: 300px;
        }

        #popup-congrats img {
            width: 150px !important;
            height: auto !important;
        }

        /* Điều chỉnh nút thống kê */
        .stats-btn {
            width: 40px;
            height: 40px;
            font-size: 20px;
            bottom: 10px;
            right: 10px;
        }

        .stats-content {
            width: 95%;
            max-width: none;
            margin: 10px;
            padding: 15px;
        }

        /* Tối ưu hiệu ứng */
        .notification {
            width: 90%;
            font-size: 14px;
            padding: 10px;
        }

        /* Tối ưu scrolling */
        html {
            scroll-behavior: smooth;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }
    }
    /* Thêm CSS cho profile sticky */
.profile-container {
    position: sticky;
    top: 10px;
    left: 20px;
    z-index: 1000;
    display: flex;
    justify-content: center;
    padding: 10px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 15px;
}

.profile-container img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #FF7043;
}

.profile-info {
    margin-left: 10px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.profile-name {
    font-weight: bold;
    color: #FF7043;
}

.profile-level {
    font-size: 14px;
    color: #795548;
}

/* Điều chỉnh responsive */
@media screen and (max-width: 768px) {
    .profile-container {
        position: sticky;
        top: 0;
        left: 0;
        width: 100%;
        margin: 0;
        border-radius: 0;
    }
}
/* Cập nhật CSS cho profile container */
.profile-container {
    position: sticky;
    top: 10px;
    display: flex;
    align-items: center;
    padding: 10px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 15px;
    z-index: 1000;
}

.profile-container img {
    width: 100px; /* Tăng kích thước ảnh */
    height: 100px;
    border-radius: 10px;
    object-fit: cover;
    border: 3px solid #FF7043;
}

.profile-info {
    margin-left: 15px;
}

/* Responsive cho mobile */
@media screen and (max-width: 768px) {
    .profile-container {
        flex-direction: row; /* Giữ layout ngang trên mobile */
        margin: 0;
        padding: 8px;
        width: 100%;
        border-radius: 0;
        background: rgba(255, 255, 255, 0.98);
    }

    .profile-container img {
        width: 80px; /* Giảm kích thước ảnh trên mobile nhưng vẫn đủ lớn */
        height: 80px;
    }

    .profile-info {
        margin-left: 12px;
        text-align: left;
    }
}
/* CSS cho phần cây và nút tưới */
.tree-container {
    position: relative;
    padding: 20px;
    margin-top: 20px;
    text-align: center;
}

.tree-image {
    width: 200px;
    height: 200px;
    transition: transform 0.3s ease;
}

.tree-name {
    font-size: 20px;
    font-weight: bold;
    color: #4CAF50;
    margin: 10px 0;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

.water-button {
    position: absolute;
    right: -20px;
    top: 50%;
    transform: translateY(-50%);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(45deg, #2196F3, #03A9F4);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pulse 2s infinite;
}

.water-button:hover {
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.4); }
    70% { box-shadow: 0 0 0 15px rgba(33, 150, 243, 0); }
    100% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); }
}

.tree-growth {
    animation: grow 1s ease-out;
}

@keyframes grow {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

@keyframes leaves {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.2); }
    100% { filter: brightness(1); }
}

/* Responsive design */
@media screen and (max-width: 768px) {
    .tree-container {
        padding: 10px;
        margin-top: 10px;
    }

    .tree-image {
        width: 300px; /* Tăng từ 150px lên 300px */
        height: 300px; /* Tăng từ 150px lên 300px */
    }

    .water-button {
        width: 80px; /* Tăng size nút tưới nước */
        height: 80px;
        font-size: 24px;
        right: -15px;
    }
}
.xp-bar {
    height: 6px;
    background-color: #ddd;
    border-radius: 3px;
    margin: 5px 0;
    overflow: hidden;
}

.xp-progress {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.3s;
}

.level-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    background: linear-gradient(45deg, #FF6D00, #FFA726);
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.weekly-challenge {
    background: linear-gradient(45deg, #7E57C2, #5C6BC0);
    color: white;
    padding: 15px;
    border-radius: 12px;
    margin: 15px 0;
    animation: pulse 2s infinite;
}

.challenge-progress {
    margin-top: 10px;
    font-size: 14px;
}

.challenge-reward {
    display: inline-block;
    font-size: 24px;
    margin-top: 5px;
}

.competition-section {
    background: white;
    padding: 15px;
    border-radius: 12px;
    margin: 15px 0;
}

.vs-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin: 15px 0;
}

.vs-player {
    text-align: center;
    position: relative;
}

.vs-score {
    font-size: 24px;
    font-weight: bold;
    margin: 5px 0;
}

.vs-text {
    font-size: 24px;
    font-weight: bold;
    color: #FF5722;
}
.admin-btn {
    position: absolute;
    right: 10px;
    bottom: 10px;
    background: #FF5722;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    z-index: 1000;
}
</style>
</head>
<body>
    
<!-- Thêm div chứa hình ảnh và thông tin của 2 em -->
<div class="profile-container" id="tridung-profile">
    <img src="images/vit.jpg" alt="Trí Dũng">
    <div class="profile-info">
        <div class="profile-name">Trí Dũng</div>
        <div class="profile-level">Cấp <span id="tridung-level">1</span></div>
    </div>
</div>

<div class="profile-container" id="thaoVy-profile" style="display: none;">
    <img src="images/vy.jpg" alt="Thảo Vy">
    <div class="profile-info">
        <div class="profile-name">Thảo Vy</div>
        <div class="profile-level">Cấp <span id="thaoVy-level">1</span></div>
    </div>
</div>

<!-- Thêm vào phần JavaScript để xử lý chuyển đổi hiển thị -->
<script>
// Cập nhật hàm switchTab để hiển thị đúng profile
let originalSwitchTab;
if (typeof switchTab !== 'undefined') {
    originalSwitchTab = switchTab;
    switchTab = function(childName) {
        originalSwitchTab(childName);
        updateLevelDisplay();
        
        // Ẩn/hiện profile tương ứng
        document.getElementById('tridung-profile').style.display = childName === 'tridung' ? 'block' : 'none';
        document.getElementById('thaoVy-profile').style.display = childName === 'thaoVy' ? 'block' : 'none';
    };
}
</script>
<div class="container">
<div class="header">
<h1>Thời gian biểu cho bé</h1>
</div>
<div class="date-container">
<div class="date-display" id="currentDate">Hôm nay, 17/04/2025</div>
<div class="date-nav">
<button class="date-btn" onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
<button class="date-btn" onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('tridung')">
        <img src="images/vit.jpg" style="width:30px; height:30px; border-radius:50%; margin-right:5px; vertical-align:middle;">
        Trí Dũng (5 tuổi)
    </div>
    <div class="tab" onclick="switchTab('thaoVy')">
        <img src="images/vy.jpg" style="width:30px; height:30px; border-radius:50%; margin-right:5px; vertical-align:middle;">
        Thảo Vy (3 tuổi)
    </div>
</div>

<div class="weekly-challenge" id="weeklyChallenge">
    <h3><i class="fas fa-star"></i> Thử thách tuần này</h3>
    <div id="challengeText">7 ngày ngủ đúng giờ liên tiếp</div>
    <div class="challenge-progress">
        Tiến độ: <span id="challengeProgress">0</span>/7 ngày
    </div>
    <div class="challenge-reward">🏆</div>
</div>

<div class="competition-section">
    <h3><i class="fas fa-trophy"></i> Thi đua tuần này</h3>
    <div class="vs-container">
        <div class="vs-player">
            <img src="images/vit.jpg" style="width:60px; height:60px; border-radius:50%;">
            <div class="level-badge">Cấp <span id="tridungLevel">1</span></div>
            <div class="vs-score" id="tridungScore">0</div>
            <div class="xp-bar">
                <div class="xp-progress" id="tridungXP" style="width:0%"></div>
            </div>
        </div>
        <div class="vs-text">VS</div>
        <div class="vs-player">
            <img src="images/vy.jpg" style="width:60px; height:60px; border-radius:50%;">
            <div class="level-badge">Cấp <span id="thaoVyLevel">1</span></div>
            <div class="vs-score" id="thaoVyScore">0</div>
            <div class="xp-bar">
                <div class="xp-progress" id="thaoVyXP" style="width:0%"></div>
            </div>
        </div>
    </div>
</div>

<style>
.tab {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    /* ...existing styles... */
}

.tab img {
    transition: transform 0.3s ease;
}

.tab:hover img {
    transform: scale(1.1);
}

.tab.active img {
    border: 2px solid #fff;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}
</style>

<div class="progress">
<div class="progress-bar" id="progressBar" style="width: 0%">0/16 điểm</div>
</div>
<div class="child-tab" id="tridung">
<div class="sleep-record" id="sleepRecord">
<div><i class="fas fa-bed"></i> Ngủ đêm qua:</div>
<div id="sleepStatus">Chưa có dữ liệu</div>
</div>
<div class="task-list">
<!-- Tasks will be added here dynamically -->
</div>
</div>
<div class="child-tab" id="thaoVy" style="display:none">
<div class="sleep-record" id="sleepRecordThaoVy">
<div><i class="fas fa-bed"></i> Ngủ đêm qua:</div>
<div id="sleepStatusThaoVy">Chưa có dữ liệu</div>
</div>
<div class="task-list">
<!-- Tasks will be added here dynamically -->
</div>
</div>
<div class="reward" id="reward">
<i class="fas fa-trophy"></i> Chúc mừng! Bé đã hoàn thành nhiệm vụ và được phép chơi thiết bị điện tử từ 20:00 - 21:00
        </div>
</div>
<div class="notification" id="notification">
<i class="fas fa-bell"></i> Đến giờ thực hiện nhiệm vụ mới!
    </div>
<button class="stats-btn" onclick="toggleStats()">
<i class="fas fa-chart-bar"></i>
</button>
<div class="stats-modal" id="statsModal">
<div class="stats-content">
<div class="stats-header">
<h2>Thống kê hoạt động</h2>
<button class="stats-close" onclick="toggleStats()"><i class="fas fa-times"></i></button>
</div>
<div class="stats-chart" id="statsChart">
<!-- Chart bars will be added here -->
</div>
<div class="stats-summary">
<h3>Tóm tắt 7 ngày qua</h3>
<p><strong>Tổng điểm:</strong> <span id="totalPoints">0</span> điểm</p>
<p><strong>Điểm trung bình:</strong> <span id="averagePoints">0</span> điểm/ngày</p>
<p><strong>Ngày tốt nhất:</strong> <span id="bestDay">Chưa có dữ liệu</span></p>
<p><strong>Số ngày được chơi thiết bị:</strong> <span id="deviceDays">0</span>/7 ngày</p>
</div>
</div>
</div>
<script>
        // Thiết lập ngày hiện tại
        let currentDate = new Date();
        let currentChild = 'tridung';
        
        // Dữ liệu lưu trữ
        const storageKey = 'kidScheduleData';
        let scheduleData = {
            tridung: {},
            thaoVy: {}
        };
        
        // Hạng mục đánh giá
        const ratingValues = {
            good: 3,
            neutral: 1,
            bad: 0
        };
        
        // Danh sách nhiệm vụ cố định
        const taskTemplates = {
    tridung: [
        { id: 'sleep-prev', time: "21:00", name: "Đi ngủ (đêm qua)", isPreviousSleep: true, ratings: ["Đúng giờ", "Trễ giờ", "Không ngủ"] },
        { id: 'wake-up', time: "6:30 - 7:00", name: "Thức dậy, vệ sinh cá nhân, đi học", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
        { id: 'free-time', time: "17:00 - 18:00", name: "Chơi tự do", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
        { id: 'dinner', time: "18:00 - 18:30", name: "Ăn tối tại nhà", ratings: ["Ăn nhanh và hết", "Ăn chậm", "Không chịu ăn"] },
        { id: 'evening-hygiene', time: "18:30 - 19:00", name: "Vệ sinh cá nhân buổi tối", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
        { id: 'study', time: "19:00 - 20:00", name: "Đọc sách, tô màu hoặc làm toán", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
        { id: 'sleep', time: "21:00", name: "Đi ngủ", ratings: ["Đúng giờ", "Trễ giờ", "Không ngủ"] }
    ],
    thaoVy: [
        { id: 'sleep-prev', time: "21:00", name: "Đi ngủ (đêm qua)", isPreviousSleep: true, ratings: ["Đúng giờ", "Trễ giờ", "Không ngủ"] },
        { id: 'wake-up', time: "6:30 - 7:00", name: "Thức dậy, vệ sinh cá nhân, đi học", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
        { id: 'free-time', time: "17:00 - 18:00", name: "Chơi tự do", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
        { id: 'dinner', time: "18:00 - 18:30", name: "Ăn tối tại nhà", ratings: ["Ăn nhanh và hết", "Ăn chậm", "Không chịu ăn"] },
        { id: 'evening-hygiene', time: "18:30 - 19:00", name: "Vệ sinh cá nhân buổi tối", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
        { id: 'study', time: "19:00 - 20:00", name: "Đọc sách, tô màu", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
        { id: 'sleep', time: "21:00", name: "Đi ngủ", ratings: ["Đúng giờ", "Trễ giờ", "Không ngủ"] }
    ]
};
        
        // Hiển thị ngày hiện tại
        function updateDateDisplay() {
            const options = { weekday: 'long', day: 'numeric', month: 'numeric', year: 'numeric' };
            const dateString = currentDate.toLocaleDateString('vi-VN', options);
            const capitalizedDate = dateString.charAt(0).toUpperCase() + dateString.slice(1);
            document.getElementById('currentDate').textContent = capitalizedDate;
        }
        
        // Đổi ngày
        function changeDate(delta) {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + delta);
            currentDate = newDate;
            updateDateDisplay();
            renderTasks();
            updateSleepRecord();
            checkReward();
        }
        
        // Lấy key cho ngày hiện tại
        function getDateKey(date = currentDate) {
            return date.toISOString().split('T')[0];
        }
        
        // Lấy key cho ngày hôm trước
        function getPreviousDateKey() {
            const prevDate = new Date(currentDate);
            prevDate.setDate(prevDate.getDate() - 1);
            return getDateKey(prevDate);
        }
        
        // Cập nhật trạng thái ngủ của ngày hôm trước
        function updateSleepRecord() {
            const prevDateKey = getPreviousDateKey();
            const currentDateKey = getDateKey();
            
            // Kiểm tra trạng thái ngủ cho Trí Dũng
            const sleepStatus = document.getElementById('sleepStatus');
            if (scheduleData.tridung[prevDateKey] && scheduleData.tridung[prevDateKey].tasks) {
                const sleepTask = scheduleData.tridung[prevDateKey].tasks.find(t => t.id === 7);
                if (sleepTask && sleepTask.rating) {
                    sleepStatus.textContent = sleepTask.rating === 'good' ? 'Tốt' : 
                                              sleepTask.rating === 'neutral' ? 'Trễ giờ' : 'Không ngủ';
                    
                    const sleepRecord = document.getElementById('sleepRecord');
                    sleepRecord.className = 'sleep-record ' + sleepTask.rating;
                } else {
                    sleepStatus.textContent = 'Chưa có dữ liệu';
                    document.getElementById('sleepRecord').className = 'sleep-record';
                }
            } else {
                sleepStatus.textContent = 'Chưa có dữ liệu';
                document.getElementById('sleepRecord').className = 'sleep-record';
            }
            
            // Kiểm tra trạng thái ngủ cho Thảo Vy
            const sleepStatusThaoVy = document.getElementById('sleepStatusThaoVy');
            if (scheduleData.thaoVy[prevDateKey] && scheduleData.thaoVy[prevDateKey].tasks) {
                const sleepTaskThaoVy = scheduleData.thaoVy[prevDateKey].tasks.find(t => t.id === 7);
                if (sleepTaskThaoVy && sleepTaskThaoVy.rating) {
                    sleepStatusThaoVy.textContent = sleepTaskThaoVy.rating === 'good' ? 'Tốt' : 
                                                  sleepTaskThaoVy.rating === 'neutral' ? 'Trễ giờ' : 'Không ngủ';
                    
                    const sleepRecordThaoVy = document.getElementById('sleepRecordThaoVy');
                    sleepRecordThaoVy.className = 'sleep-record ' + sleepTaskThaoVy.rating;
                } else {
                    sleepStatusThaoVy.textContent = 'Chưa có dữ liệu';
                    document.getElementById('sleepRecordThaoVy').className = 'sleep-record';
                }
            } else {
                sleepStatusThaoVy.textContent = 'Chưa có dữ liệu';
                document.getElementById('sleepRecordThaoVy').className = 'sleep-record';
            }
            
            // Chuẩn bị dữ liệu cho ngày hiện tại nếu chưa có
            ['tridung', 'thaoVy'].forEach(child => {
                if (!scheduleData[child][currentDateKey]) {
                    scheduleData[child][currentDateKey] = {
                        tasks: [],
                        totalPoints: 0
                    };
                    
                    // Tạo các nhiệm vụ từ template
                    scheduleData[child][currentDateKey].tasks = taskTemplates[child].map(template => {
                        return {
                            id: template.id,
                            time: template.time,
                            name: template.name,
                            isPreviousSleep: template.isPreviousSleep || false,
                            rating: null
                        };
                    });
                }
            });
        }
        
        // Hiển thị danh sách nhiệm vụ
        function renderTasks() {
            const dateKey = getDateKey();
            
            // Render nhiệm vụ cho Trí Dũng
            const tridungTaskList = document.querySelector('#tridung .task-list');
            tridungTaskList.innerHTML = '';
            
            if (scheduleData.tridung[dateKey] && scheduleData.tridung[dateKey].tasks) {
                // Lọc ra nhiệm vụ của ngày hiện tại (không phải ngủ của ngày hôm trước)
                const currentTasks = scheduleData.tridung[dateKey].tasks.filter(task => !task.isPreviousSleep);
                
                currentTasks.forEach(task => {
                    const taskElement = createTaskElement(task, 'tridung');
                    tridungTaskList.appendChild(taskElement);
                });
            }
            
            // Render nhiệm vụ cho Thảo Vy
            const thaoVyTaskList = document.querySelector('#thaoVy .task-list');
            thaoVyTaskList.innerHTML = '';
            
            if (scheduleData.thaoVy[dateKey] && scheduleData.thaoVy[dateKey].tasks) {
                // Lọc ra nhiệm vụ của ngày hiện tại (không phải ngủ của ngày hôm trước)
                const currentTasks = scheduleData.thaoVy[dateKey].tasks.filter(task => !task.isPreviousSleep);
                
                currentTasks.forEach(task => {
                    const taskElement = createTaskElement(task, 'thaoVy');
                    thaoVyTaskList.appendChild(taskElement);
                });
            }
            
            updateProgress();
        }
        
        // Tạo phần tử nhiệm vụ
        function createTaskElement(task, childName) {
            const taskElement = document.createElement('div');
            taskElement.className = `task ${task.rating ? 'completed-' + task.rating : ''}`;
            taskElement.setAttribute('data-task-id', task.id);
            
            const template = taskTemplates[childName].find(t => t.id === task.id);
            
            taskElement.innerHTML = `
                <div class="task-header">
                    <div class="task-time">${task.time}</div>
                    <div class="task-name">${task.name}</div>
                </div>
                <div class="rating-buttons">
                    <button class="rating-btn good-btn ${task.rating === 'good' ? 'active' : ''}" 
                            onclick="rateTask('${childName}', ${task.id}, 'good')">
                        <i class="fas fa-smile"></i> ${template.ratings[0]}
                    </button>
                    <button class="rating-btn neutral-btn ${task.rating === 'neutral' ? 'active' : ''}" 
                            onclick="rateTask('${childName}', ${task.id}, 'neutral')">
                        <i class="fas fa-meh"></i> ${template.ratings[1]}
                    </button>
                    <button class="rating-btn bad-btn ${task.rating === 'bad' ? 'active' : ''}" 
                            onclick="rateTask('${childName}', ${task.id}, 'bad')">
                        <i class="fas fa-frown"></i> ${template.ratings[2]}
                    </button>
                </div>
            `;
            
            // Kiểm tra và hiển thị streak
            setTimeout(() => checkIterativeProgress(childName, task.id), 0);
            
            return taskElement;
        }
        
        
        // Tính lại tổng điểm
        function recalculateTotalPoints(childName, dateKey) {
            let totalPoints = 0;
            
            if (scheduleData[childName][dateKey] && scheduleData[childName][dateKey].tasks) {
                scheduleData[childName][dateKey].tasks.forEach(task => {
                    if (task.rating) {
                        totalPoints += ratingValues[task.rating];
                    }
                });
scheduleData[childName][dateKey].totalPoints = totalPoints;
            }
        }
        
        // Cập nhật thanh tiến trình
        function updateProgress() {
            const dateKey = getDateKey();
            const childData = scheduleData[currentChild][dateKey];
            
            if (childData) {
                const totalPoints = childData.totalPoints || 0;
                const maxPoints = taskTemplates[currentChild].length * 3;
                const progressPercent = (totalPoints / maxPoints) * 100;
                
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = `${progressPercent}%`;
                progressBar.textContent = `${totalPoints}/${maxPoints} điểm`;
            }
        }
        
        // Kiểm tra xem có đạt yêu cầu nhận phần thưởng không
        function checkReward() {
            const dateKey = getDateKey();
            const prevDateKey = getPreviousDateKey();
            
            // Kiểm tra xem có dữ liệu cho ngày hiện tại và ngày hôm trước không
            if (!scheduleData[currentChild][dateKey] || !scheduleData[currentChild][prevDateKey]) {
                document.getElementById('reward').classList.remove('active');
                return;
            }
            
            // Kiểm tra đánh giá ngủ của ngày hôm trước
            const previousSleepTask = scheduleData[currentChild][prevDateKey].tasks.find(t => t.id === 7);
            const goodSleepYesterday = previousSleepTask && (previousSleepTask.rating === 'good' || previousSleepTask.rating === 'neutral');
            
            // Kiểm tra tổng điểm của ngày hôm nay (cần đạt ít nhất 12 điểm)
            const goodPointsToday = scheduleData[currentChild][dateKey].totalPoints >= 12;
            
            // Hiển thị phần thưởng nếu đủ điều kiện
            const rewardElement = document.getElementById('reward');
            if (goodSleepYesterday && goodPointsToday) {
                rewardElement.classList.add('active');
            } else {
                rewardElement.classList.remove('active');
            }
        }
        
        // Chuyển đổi giữa các tab
        function switchTab(childName) {
            currentChild = childName;
            
            // Cập nhật trạng thái tab
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`.tab[onclick="switchTab('${childName}')"]`);
            activeTab.classList.add('active');
            
            // Hiển thị tab con tương ứng
            const childTabs = document.querySelectorAll('.child-tab');
            childTabs.forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Sửa tên biến cho đúng - thaoVy thành thaoVy
            document.getElementById(childName === 'tridung' ? 'tridung' : 'thaoVy').style.display = 'block';
            
            // Ẩn/hiện profile tương ứng
            document.getElementById('tridung-profile').style.display = childName === 'tridung' ? 'block' : 'none';
            document.getElementById('thaoVy-profile').style.display = childName === 'thaoVy' ? 'block' : 'none';
            
            // Cập nhật tiến trình và trạng thái phần thưởng
            updateProgress();
            checkReward();
            
            // Cập nhật tên cây
            const treeName = document.getElementById('tree-name');
            treeName.textContent = `Cây của bé ${childName === 'tridung' ? 'Trí Dũng' : 'Thảo Vy'}`;
        }
        
        // Hiển thị thông báo
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.innerHTML = `<i class="fas fa-bell"></i> ${message}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Kiểm tra thông báo dựa trên thời gian
        function checkTaskNotifications() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            const dateKey = getDateKey();
            
            // Kiểm tra cả hai bé
            ['tridung', 'thaoVy'].forEach(childName => {
                if (scheduleData[childName][dateKey] && scheduleData[childName][dateKey].tasks) {
                    scheduleData[childName][dateKey].tasks.forEach(task => {
                        if (!task.isPreviousSleep) { // Bỏ qua nhiệm vụ ngủ của ngày hôm trước
                            const timeRange = task.time.split(' - ');
                            if (timeRange.length > 1) {
                                const startTime = timeRange[0].split(':');
                                const startHour = parseInt(startTime[0]);
                                const startMinute = parseInt(startTime[1]);
                                
                                if (hours === startHour && minutes === startMinute && !task.rating) {
                                    showNotification(`${childName === 'tridung' ? 'Trí Dũng' : 'Thảo Vy'}: Đến giờ ${task.name}`);
                                }
                            } else if (timeRange[0].includes(':')) {
                                const exactTime = timeRange[0].split(':');
                                const exactHour = parseInt(exactTime[0]);
                                const exactMinute = parseInt(exactTime[1]);
                                
                                if (hours === exactHour && minutes === exactMinute && !task.rating) {
                                    showNotification(`${childName === 'tridung' ? 'Trí Dũng' : 'Thảo Vy'}: Đến giờ ${task.name}`);
                                }
                            }
                        }
                    });
                }
            });
        }
        
        // Hiển thị/ẩn modal thống kê
        function toggleStats() {
            const statsModal = document.getElementById('statsModal');
            statsModal.classList.toggle('active');
            
            if (statsModal.classList.contains('active')) {
                updateStats();
            }
        }
        
        // Cập nhật thống kê
        function updateStats() {
            const statsChart = document.getElementById('statsChart');
            statsChart.innerHTML = '';
            
            // Lấy dữ liệu 7 ngày gần nhất
            const last7Days = [];
            let totalPoints = 0;
            let deviceDays = 0;
            let bestDay = { date: null, points: 0 };
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - i);
                const dateKey = getDateKey(date);
                
                // Format ngày hiển thị
                const dayDisplay = date.getDate() + '/' + (date.getMonth() + 1);
                
                // Dữ liệu điểm
                let dayPoints = 0;
                if (scheduleData[currentChild][dateKey] && scheduleData[currentChild][dateKey].totalPoints) {
                    dayPoints = scheduleData[currentChild][dateKey].totalPoints;
                }
                
                // Thêm vào tổng điểm
                totalPoints += dayPoints;
                
                // Kiểm tra ngày tốt nhất
                if (dayPoints > bestDay.points) {
                    bestDay = {
                        date: new Date(date),
                        points: dayPoints
                    };
                }
                
                // Kiểm tra xem ngày đó có được chơi thiết bị không
                const prevDate = new Date(date);
                prevDate.setDate(prevDate.getDate() - 1);
                const prevDateKey = getDateKey(prevDate);
                
                // Điều kiện được chơi thiết bị: Ngủ tốt ngày hôm trước + điểm cao ngày hôm nay
                let canUseDevice = false;
                
                if (scheduleData[currentChild][prevDateKey] && scheduleData[currentChild][dateKey]) {
                    const previousSleepTask = scheduleData[currentChild][prevDateKey].tasks?.find(t => t.id === 7);
                    const goodSleepYesterday = previousSleepTask && (previousSleepTask.rating === 'good' || previousSleepTask.rating === 'neutral');
                    const goodPointsToday = dayPoints >= 12;
                    
                    canUseDevice = goodSleepYesterday && goodPointsToday;
                    if (canUseDevice) deviceDays++;
                }
                
                // Thêm vào mảng dữ liệu
                last7Days.push({
                    date: dayDisplay,
                    points: dayPoints,
                    canUseDevice: canUseDevice
                });
            }
            
            // Tạo biểu đồ
            last7Days.forEach(day => {
                // Tính chiều cao dựa trên điểm (tối đa 21 điểm ~ chiều cao 100%)
                const heightPercent = (day.points / 21) * 100;
                
                const barElement = document.createElement('div');
                barElement.className = `chart-bar ${day.canUseDevice ? 'good-btn' : ''}`;
                barElement.style.height = `${heightPercent}%`;
                
                barElement.innerHTML = `
                    <div class="chart-bar-value">${day.points}</div>
                    <div class="chart-bar-label">${day.date}</div>
                `;
                
                statsChart.appendChild(barElement);
            });
            
            // Cập nhật tóm tắt thống kê
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('averagePoints').textContent = (totalPoints / 7).toFixed(1);
            document.getElementById('deviceDays').textContent = deviceDays;
            
            if (bestDay.date) {
                const options = { weekday: 'long', day: 'numeric', month: 'numeric' };
                const bestDayStr = bestDay.date.toLocaleDateString('vi-VN', options);
                document.getElementById('bestDay').textContent = `${bestDayStr} (${bestDay.points} điểm)`;
            } else {
                document.getElementById('bestDay').textContent = 'Chưa có dữ liệu';
            }
        }
        


// Sửa hàm saveData để lưu dữ liệu cây
// Hàm lưu dữ liệu
function saveData() {
    localStorage.setItem(storageKey, JSON.stringify(scheduleData));
    
    // Lưu dữ liệu cây
    localStorage.setItem('treeData', JSON.stringify({
        waterCredits: waterCredits,
        treeLevel: treeLevel
    }));
}
function updateTreeImage() {
    // Xác định cấp độ cây dựa vào ngày trong tuần
    const weekDay = new Date().getDay(); // 0: Chủ Nhật, 1: Thứ 2...
    
    // Nếu là chủ nhật, hiển thị cây trưởng thành
    if (weekDay === 0) {
        document.getElementById("tree-img").src = "images/tree_day7.png";
        document.getElementById("tree-status").textContent = "Cây đã trưởng thành hoàn toàn! Chúc mừng bé!";
        document.getElementById("tree-status").style.color = "#4CAF50";
    } else {
        // Các ngày khác trong tuần, hiển thị theo tiến độ
        // Thứ 2 (1) -> cấp độ 1, Thứ 3 (2) -> cấp độ 2, ..., Thứ 7 (6) -> cấp độ 6
        const expectedLevel = weekDay; // Cấp độ mong đợi cho ngày hiện tại
        
        // Hiển thị cây theo cấp độ thực tế (không vượt quá cấp độ mong đợi)
        const displayLevel = Math.min(treeLevel, expectedLevel);
        document.getElementById("tree-img").src = `images/tree_day${displayLevel}.png`;
        
        // Hiển thị thông báo về trạng thái cây
        if (treeLevel < expectedLevel) {
            document.getElementById("tree-status").textContent = "Cây cần thêm nước để phát triển!";
            document.getElementById("tree-status").style.color = "#FF9800";
        } else {
            document.getElementById("tree-status").textContent = "Cây đang phát triển tốt!";
            document.getElementById("tree-status").style.color = "#4CAF50";
        }
    }
}

// Hàm tải dữ liệu
function loadData() {
    const savedData = localStorage.getItem(storageKey);
    if (savedData) {
        scheduleData = JSON.parse(savedData);
    }
    
    // Tải dữ liệu cây
    const treeData = localStorage.getItem('treeData');
    if (treeData) {
        const parsedTreeData = JSON.parse(treeData);
        waterCredits = parsedTreeData.waterCredits || 0;
        treeLevel = parsedTreeData.treeLevel || 1;
        
        // Cập nhật UI
        document.getElementById("water-units").textContent = waterCredits;
        updateTreeImage();
        
        console.log("Đã tải dữ liệu: lượt tưới =", waterCredits, "cấp độ cây =", treeLevel);
    }
    
    // Lấy ngày trong tuần hiện tại
    currentWeekDay = new Date().getDay(); // 0: Chủ Nhật, 1: Thứ 2...
    
    // Khởi tạo ngày hiện tại nếu chưa có
    initializeCurrentDate();
    checkAndResetTree();
    updateDateDisplay();
    updateSleepRecord();
    renderTasks();
    checkReward();
    if (localStorage.getItem('challenges')) {
        Object.assign(challenges, JSON.parse(localStorage.getItem('challenges')));
    }
    displaySchedule();
    displayChallenges();
}
        
        // Khởi tạo dữ liệu cho ngày hiện tại nếu chưa có
        function initializeCurrentDate() {
            const dateKey = getDateKey();
            
            ['tridung', 'thaoVy'].forEach(child => {
                if (!scheduleData[child][dateKey]) {
                    scheduleData[child][dateKey] = {
                        tasks: [],
                        totalPoints: 0
                    };
                    
                    // Tạo các nhiệm vụ từ template
                    scheduleData[child][dateKey].tasks = taskTemplates[child].map(template => {
                        return {
                            id: template.id,
                            time: template.time,
                            name: template.name,
                            isPreviousSleep: template.isPreviousSleep || false,
                            rating: null
                        };
                    });
                }
            });
        }
        
        // Kiểm tra thông báo mỗi phút
        setInterval(checkTaskNotifications, 60000);
        
        // Thêm sự kiện lưu dữ liệu
        window.addEventListener('beforeunload', saveData);
        
        // Khởi chạy ứng dụng
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
<div id="popup-congrats" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%, -50%); z-index:9999; text-align:center;">
<img alt="Mẹ Quỳnh" src="images/me_quynh.jpg" style="width:250px; border-radius:10px; box-shadow: 0 0 10px #888;"/>
<div id="popup-text" style="background:white; padding:10px; font-weight:bold; font-size:18px; margin-top:-5px;">Bé làm tốt lắm!</div>
</div>
<audio id="audio-congrats" preload="auto" src=""></audio>
<img id="watering-gif" src="images/water.gif" style="display:none; position:absolute; width:120px; top:350px; left:1190px; z-index:10;"/>

<!-- Thay thế phần div cây cũ bằng container mới -->
<div class="tree-container">
    <img id="tree-img" src="images/tree_day1.png" class="tree-image" alt="Cây phát triển">
    <div class="tree-name" id="tree-name">
        Cây của bé Trí Dũng
    </div>
    <div id="tree-status" style="font-weight:bold; color:#FF9800; margin:5px 0;">
        Cây cần nước để phát triển!
    </div>
    <div style="margin-top:5px;">
        <span id="water-count" style="font-weight:bold; color:#2196F3;">
            💧 <span id="water-units">0</span> lượt tưới
        </span>
    </div>
    <button class="water-button" onclick="waterTree()" title="Tưới nước cho cây">
        💧
    </button>
    <button id="reset-tree" class="admin-btn" onclick="resetTree()" 
            style="position: absolute; right: -60px; bottom: 0; background: #FF5722; color: white; 
            border: none; padding: 10px; border-radius: 5px; cursor: pointer; display: none;">
        <i class="fas fa-undo"></i> Reset
    </button>
</div>

// Thêm nút reset vào tree container

document.querySelector('.tree-container').innerHTML += `
    <button id="reset-tree" class="admin-btn" onclick="resetTree()" 
            style="position: absolute; right: -60px; bottom: 0; background: #FF5722; color: white; 
            border: none; padding: 10px; border-radius: 5px; cursor: pointer; display: none;">
        <i class="fas fa-undo"></i> Reset
    </button>
`;


// Thêm hàm reset cây
function resetTree() {
    const pin = prompt("Nhập mã PIN để xác nhận reset cây (****)");
    if (pin !== "2022") {
        alert("Mã PIN không đúng!");
        return;
    }

    if (confirm("Bạn có chắc chắn muốn reset cây về trạng thái ban đầu?")) {
        treeLevel = 1;
        waterCredits = 0;
        document.getElementById("tree-img").src = "images/tree_day1.png";
        document.getElementById("tree-status").textContent = "Cây đã được reset về trạng thái ban đầu!";
        document.getElementById("water-units").textContent = "0";
        saveData();
        alert("Đã reset cây thành công!");
    }
}

// Thêm phím tắt để hiện/ẩn nút reset (Ctrl + Shift + R)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'R') {
        e.preventDefault();
        const resetBtn = document.getElementById('reset-tree');
        resetBtn.style.display = resetBtn.style.display === 'none' ? 'block' : 'none';
    }
});

// Thêm khu vực hiển thị huy hiệu
<div style="position: fixed; top: 100px; right: 20px; text-align: center; background-color: rgba(255,255,255,0.8); padding: 10px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0; color: #FF6D00;">Huy hiệu của bé</h3>
    <div id="badges-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; max-width: 150px;">
        <!-- Huy hiệu sẽ được thêm vào đây -->
    </div>
</div>
<script>
// Định nghĩa các loại huy hiệu
const badges = [
    { id: 'star3', name: '3 Ngày Sao Vàng', image: '⭐⭐⭐', condition: 'Hoàn thành tốt 3 ngày liên tiếp' },
    { id: 'sleep7', name: 'Ngủ Ngoan 7 Ngày', image: '😴🥇', condition: 'Đi ngủ đúng giờ 7 ngày liên tiếp' },
    { id: 'tree', name: 'Người Trồng Cây', image: '🌳👑', condition: 'Cây phát triển đầy đủ' },
    { id: 'eat5', name: 'Ăn Giỏi 5 Ngày', image: '🍽️🏆', condition: 'Ăn tối ngoan 5 ngày liên tiếp' }
];

// Hàm kiểm tra và cấp huy hiệu mới
function checkAndAwardBadges() {
    // Lấy danh sách huy hiệu đã có
    let earnedBadges = JSON.parse(localStorage.getItem('earnedBadges') || '{}');
    
    // Kiểm tra điều kiện cấp huy hiệu mới
    
    // Ví dụ: Huy hiệu 3 ngày sao vàng
    let consecutiveGoodDays = 0;
    for (let i = 0; i < 3; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateKey = getDateKey(date);
        
        if (scheduleData[currentChild][dateKey] && scheduleData[currentChild][dateKey].totalPoints >= 15) {
            consecutiveGoodDays++;
        } else {
            break;
        }
    }
    
    if (consecutiveGoodDays >= 3 && !earnedBadges['star3']) {
        // Cấp huy hiệu mới
        earnedBadges['star3'] = {
            dateAwarded: new Date().toISOString(),
            forChild: currentChild
        };
        
        // Hiệu ứng thông báo huy hiệu mới
        showBadgeAward('star3');
    }
    
    // Lưu danh sách huy hiệu
    localStorage.setItem('earnedBadges', JSON.stringify(earnedBadges));
    
    // Cập nhật hiển thị huy hiệu
    renderBadges();
}

// Hiệu ứng hiển thị huy hiệu mới
function showBadgeAward(badgeId) {
    const badge = badges.find(b => b.id === badgeId);
    if (!badge) return;
    
    // Tạo phần tử thông báo
    const notification = document.createElement('div');
    notification.style.position = 'fixed';
    notification.style.top = '50%';
    notification.style.left = '50%';
    notification.style.transform = 'translate(-50%, -50%)';
    notification.style.background = 'linear-gradient(45deg, #FF9800, #FF5722)';
    notification.style.color = 'white';
    notification.style.padding = '20px';
    notification.style.borderRadius = '15px';
    notification.style.boxShadow = '0 5px 30px rgba(0,0,0,0.3)';
    notification.style.textAlign = 'center';
    notification.style.zIndex = '10000';
    notification.style.fontSize = '24px';
    notification.style.animation = 'badgeWiggle 1s infinite';
    
    // Thêm style animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes badgeWiggle {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-53%) rotate(-5deg); }
            75% { transform: translate(-47%) rotate(5deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }
        
        @keyframes badgeFade {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
    `;
    document.head.appendChild(style);
    
    // Nội dung thông báo
    notification.innerHTML = `
        <div style="font-size: 72px; margin-bottom: 10px;">${badge.image}</div>
        <div style="font-weight: bold; margin-bottom: 10px;">🎉 CHÚC MỪNG BÉ! 🎉</div>
        <div>Bé đã đạt được huy hiệu mới:</div>
        <div style="font-weight: bold; font-size: 28px; margin: 10px 0;">${badge.name}</div>
        <div>${badge.condition}</div>
        <button style="margin-top: 20px; padding: 10px 20px; background: white; color: #FF5722; border: none; border-radius: 30px; font-weight: bold; cursor: pointer;">Cảm ơn</button>
    `;
    
    // Thêm vào body
    document.body.appendChild(notification);
    
    // Xử lý sự kiện nút đóng
    notification.querySelector('button').addEventListener('click', () => {
        notification.style.animation = 'badgeFade 0.5s forwards';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 500);
    });
    
    // Tự động đóng sau 10 giây
    setTimeout(() => {
        if (document.body.contains(notification)) {
            notification.style.animation = 'badgeFade 0.5s forwards';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 500);
        }
    }, 10000);
    
    // Phát âm thanh vui nhộn
    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/218/218-preview.mp3');
    audio.play().catch(e => console.warn("Không thể phát âm thanh:", e));
}
// Thêm vào phần đầu script
let childLevel = {
    tridung: 1,
    thaoVy: 1
};

// Kiểm tra và nâng cấp
function checkAndUpgradeLevel() {
    // Đọc dữ liệu cấp độ từ localStorage nếu có
    const savedLevels = localStorage.getItem('childLevels');
    if (savedLevels) {
        childLevel = JSON.parse(savedLevels);
    }
    
    // Tính tổng điểm của 7 ngày gần nhất
    let weeklyPoints = 0;
    for (let i = 0; i < 7; i++) {
        const date = new Date(currentDate);
        date.setDate(date.getDate() - i);
        const dateKey = getDateKey(date);
        
        if (scheduleData[currentChild][dateKey] && scheduleData[currentChild][dateKey].totalPoints) {
            weeklyPoints += scheduleData[currentChild][dateKey].totalPoints;
        }
    }
    
    // Tính cấp độ mới dựa trên tổng điểm
    const newLevel = Math.floor(weeklyPoints / 30) + 1;
    
    // Nếu cấp độ tăng
    if (newLevel > childLevel[currentChild]) {
        // Cập nhật cấp độ
        const oldLevel = childLevel[currentChild];
        childLevel[currentChild] = newLevel;
        
        // Lưu vào localStorage
        localStorage.setItem('childLevels', JSON.stringify(childLevel));
        
        // Hiển thị thông báo nâng cấp
        showLevelUpNotification(oldLevel, newLevel);
        
        // Cập nhật hiển thị
        updateLevelDisplay();
    }
}

// Hiển thị thông báo nâng cấp
function showLevelUpNotification(oldLevel, newLevel) {
    // Tạo phần tử thông báo
    const notification = document.createElement('div');
    notification.style.position = 'fixed';
    notification.style.top = '50%';
    notification.style.left = '50%';
    notification.style.transform = 'translate(-50%, -50%)';
    notification.style.background = 'linear-gradient(45deg, #4CAF50, #8BC34A)';
    notification.style.color = 'white';
    notification.style.padding = '20px';
    notification.style.borderRadius = '15px';
    notification.style.boxShadow = '0 5px 30px rgba(0,0,0,0.3)';
    notification.style.textAlign = 'center';
    notification.style.zIndex = '10000';
    
    // Nội dung thông báo
    notification.innerHTML = `
        <div style="font-size: 72px; margin-bottom: 10px;">🎉</div>
        <div style="font-weight: bold; margin-bottom: 10px;">CHÚC MỪNG BÉ!</div>
        <div>Bé đã lên cấp!</div>
        <div style="display: flex; align-items: center; justify-content: center; margin: 20px 0;">
            <div style="font-size: 24px; margin-right: 20px;">Cấp ${oldLevel}</div>
            <div style="font-size: 24px;">➡️</div>
            <div style="font-size: 36px; font-weight: bold; margin-left: 20px;">Cấp ${newLevel}</div>
        </div>
        <div>Hãy tiếp tục cố gắng nhé!</div>
        <button style="margin-top: 20px; padding: 10px 20px; background: white; color: #4CAF50; border: none; border-radius: 30px; font-weight: bold; cursor: pointer;">Cảm ơn</button>
    `;
    
    // Thêm vào body
    document.body.appendChild(notification);
    
    // Xử lý sự kiện nút đóng
    notification.querySelector('button').addEventListener('click', () => {
        document.body.removeChild(notification);
    });
    
    // Phát âm thanh chúc mừng
    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/220/220-preview.mp3');
    audio.play().catch(e => console.warn("Không thể phát âm thanh:", e));
    
    // Hiệu ứng pháo hoa
    createFireworks();
}

// Cập nhật hiển thị cấp độ
function updateLevelDisplay() {
    // Kiểm tra nếu phần tử hiển thị cấp độ chưa tồn tại, tạo mới
    if (!document.getElementById('child-level-display')) {
        const levelDisplay = document.createElement('div');
        levelDisplay.id = 'child-level-display';
        levelDisplay.style.position = 'fixed';
        levelDisplay.style.top = '70px';
        levelDisplay.style.left = '20px';
        levelDisplay.style.background = 'linear-gradient(45deg, #673AB7, #3F51B5)';
        levelDisplay.style.color = 'white';
        levelDisplay.style.padding = '5px 15px';
        levelDisplay.style.borderRadius = '20px';
        levelDisplay.style.fontWeight = 'bold';
        levelDisplay.style.zIndex = '999';
        document.body.appendChild(levelDisplay);
    }
    
    // Cập nhật nội dung
    const levelDisplay = document.getElementById('child-level-display');
    levelDisplay.innerHTML = `${currentChild === 'tridung' ? 'Trí Dũng' : 'Thảo Vy'} - Cấp ${childLevel[currentChild]}`;
}
// Hiển thị huy hiệu đã đạt được
function renderBadges() {
    const container = document.getElementById('badges-container');
    container.innerHTML = '';
    
    const earnedBadges = JSON.parse(localStorage.getItem('earnedBadges') || '{}');
    
    // Lọc huy hiệu của bé hiện tại
    const childBadges = Object.keys(earnedBadges)
        .filter(badgeId => earnedBadges[badgeId].forChild === currentChild)
        .map(badgeId => badges.find(b => b.id === badgeId))
        .filter(badge => !!badge);
    
    if (childBadges.length === 0) {
        container.innerHTML = '<div style="color: #757575; font-style: italic;">Bé chưa có huy hiệu nào</div>';
        return;
    }
    
    // Hiển thị huy hiệu
    childBadges.forEach(badge => {
        const badgeElement = document.createElement('div');
        badgeElement.style.fontSize = '24px';
        badgeElement.style.cursor = 'pointer';
        badgeElement.title = `${badge.name}: ${badge.condition}`;
        badgeElement.innerHTML = badge.image;
        
        badgeElement.addEventListener('click', () => {
            alert(`Huy hiệu: ${badge.name}\n${badge.condition}`);
        });
        
        container.appendChild(badgeElement);
    });
}
// Đánh giá nhiệm vụ





// Tạo hiệu ứng confetti nhỏ
function createSmallConfetti(element) {
    const rect = element.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;

    for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'fixed';
        confetti.style.width = '8px';
        confetti.style.height = '8px';
        confetti.style.backgroundColor = getRandomColor();
        confetti.style.left = `${centerX}px`;
        confetti.style.top = `${centerY}px`;
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        confetti.style.opacity = '1';
        confetti.style.zIndex = '9999';
        confetti.style.pointerEvents = 'none';
        document.body.appendChild(confetti);

        const angle = Math.random() * Math.PI * 2;
        const distance = 20 + Math.random() * 80;
        const duration = 0.5 + Math.random() * 1;

        confetti.style.transition = `transform ${duration}s ease-out, opacity ${duration}s ease-out`;

        setTimeout(() => {
            confetti.style.transform = `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) rotate(${Math.random() * 360}deg)`;
            confetti.style.opacity = '0';
        }, 10);

        setTimeout(() => {
            if (document.body.contains(confetti)) {
                document.body.removeChild(confetti);
            }
        }, duration * 1000);
    }
}

// Cập nhật hàm loadData
const originalLoadData = loadData;
loadData = function() {
    originalLoadData();
    // Hiển thị cấp độ sau khi tải dữ liệu
    updateLevelDisplay();
    // Hiển thị huy hiệu
    renderBadges();
};


// Cập nhật hàm rateTask
function rateTask(childName, taskId, rating) {
    const now = new Date();
    const currentTime = now.getHours() * 60 + now.getMinutes();
    
    // Lấy thời gian của task từ lịch
    const task = scheduleData[childName][displayedDate].tasks.find(t => t.id === taskId);
    const taskTime = parseInt(task.time.split(':')[0]) * 60 + parseInt(task.time.split(':')[1]);
    
    // Kiểm tra xem có phải ngày hiện tại không
    const today = getDateKey(now);
    if (displayedDate === today && currentTime < taskTime) {
        alert('Chưa đến giờ thực hiện nhiệm vụ này!');
        return;
    }
    
    // Kiểm tra xem có phải đang cố gắng đánh giá ngày trong tương lai không
    if (new Date(displayedDate) > now) {
        alert('Không thể đánh giá nhiệm vụ trong tương lai!');
        return;
    }

    // ...existing code...
    if (scheduleData[childName][displayedDate]) {
        const taskIndex = scheduleData[childName][displayedDate].tasks.findIndex(t => t.id === taskId);
        if (taskIndex !== -1) {
            scheduleData[childName][displayedDate].tasks[taskIndex].rating = rating;
            updateChallenges(childName, taskId, rating === 2);
            saveData();
            displaySchedule();
        }
    }
    // Nếu đánh giá tốt, tạo hiệu ứng
    if (rating === 'good') {
        const taskTemplate = taskTemplates[childName].find(t => t.id === taskId);
        if (taskTemplate) {
           playCongrats(taskTemplate.name.toLowerCase());
            addWater(1);
        }
        createFireworks(); // Gọi hiệu ứng pháo hoa
    }

    // Kiểm tra và nâng cấp
    checkAndUpgradeLevel();
    // Kiểm tra và cấp huy hiệu
    checkAndAwardBadges();
}

// Thêm cấu trúc dữ liệu cho các thử thách
const challenges = {
    'no_leftover': {
        name: 'Không ăn cơm thừa',
        duration: 5,
        taskIds: ['an-sang', 'an-trua', 'an-toi'],
        progress: {
            'Vy': 0,
            'Vít': 0
        },
        startDate: null
    },
    'sleep_on_time': {
        name: 'Ngủ đúng giờ',
        duration: 7,
        taskIds: ['di-ngu'],
        progress: {
            'Vy': 0,
            'Vít': 0
        },
        startDate: null
    }
};

function updateChallenges(childName, taskId, completed) {
    const today = getDateKey(new Date());
    
    // Khởi tạo thử thách nếu chưa có
    Object.keys(challenges).forEach(challengeId => {
        const challenge = challenges[challengeId];
        if (!challenge.startDate && completed && challenge.taskIds.includes(taskId)) {
            challenge.startDate = today;
            challenge.progress['Vy'] = 0;
            challenge.progress['Vít'] = 0;
        }
    });

    // Cập nhật tiến độ thử thách
    Object.keys(challenges).forEach(challengeId => {
        const challenge = challenges[challengeId];
        if (challenge.startDate && challenge.taskIds.includes(taskId)) {
            const daysPassed = Math.floor((new Date(today) - new Date(challenge.startDate)) / (1000 * 60 * 60 * 24));
            if (daysPassed < challenge.duration) {
                if (completed) {
                    challenge.progress[childName]++;
                }
                // Kiểm tra hoàn thành thử thách
                if (challenge.progress[childName] >= challenge.duration) {
                    alert(`Chúc mừng ${childName} đã hoàn thành thử thách "${challenge.name}"! 🏆`);
                }
            }
        }
    });
    saveData();
    displayChallenges();
}

function displayChallenges() {
    const challengesContainer = document.getElementById('challenges-container');
    if (!challengesContainer) {
        const container = document.createElement('div');
        container.id = 'challenges-container';
        container.style.marginTop = '20px';
        document.querySelector('.schedule-container').appendChild(container);
    }
    
    let html = '<h3>Thử thách tuần này:</h3>';
    Object.keys(challenges).forEach(challengeId => {
        const challenge = challenges[challengeId];
        html += `
            <div class="challenge-card" style="margin: 10px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                <h4>${challenge.name}</h4>
                <p>Thời gian: ${challenge.duration} ngày</p>
                <div class="progress">
                    <p>Vít: ${challenge.progress['Vít']}/${challenge.duration} ngày ${challenge.progress['Vít'] >= challenge.duration ? '🏆' : ''}</p>
                    <p>Vy: ${challenge.progress['Vy']}/${challenge.duration} ngày ${challenge.progress['Vy'] >= challenge.duration ? '🏆' : ''}</p>
                </div>
            </div>
        `;
    });
    document.getElementById('challenges-container').innerHTML = html;
}

// Thêm vào hàm loadData
function loadData() {
    // ...existing code...
    if (localStorage.getItem('challenges')) {
        Object.assign(challenges, JSON.parse(localStorage.getItem('challenges')));
    }
    displaySchedule();
    displayChallenges();
}

// Thêm vào hàm saveData
function saveData() {
    // ...existing code...
    localStorage.setItem('challenges', JSON.stringify(challenges));
}

// Thêm cấu trúc dữ liệu cho event thi đua
const competitionEvents = [
    {
        id: 'sleep',
        name: 'Ngủ đúng giờ',
        description: 'Ai ngủ đúng giờ nhiều ngày nhất trong tuần',
        points: 0
    },
    {
        id: 'study',
        name: 'Học tập chăm chỉ',
        description: 'Ai hoàn thành tốt nhiệm vụ học tập nhiều nhất',
        points: 0
    }
];

// Thêm vào phần competitions section
document.querySelector('.competition-section').innerHTML += `
    <div class="weekly-events">
        <h4><i class="fas fa-medal"></i> Cuộc thi tuần này</h4>
        ${competitionEvents.map(event => `
            <div class="event-card">
                <div class="event-title">${event.name}</div>
                <div class="event-desc">${event.description}</div>
                <div class="event-score">
                    <div class="player-score">
                        <span>Trí Dũng: </span>
                        <span id="${event.id}-tridung">0</span> điểm
                    </div>
                    <div class="player-score">
                        <span>Thảo Vy: </span>
                        <span id="${event.id}-thaoVy">0</span> điểm
                    </div>
                </div>
            </div>
        `).join('')}
    </div>
`;

// Thêm CSS cho event card
const styleSheet = document.createElement('style');
styleSheet.textContent = `
    .weekly-events {
        margin-top: 20px;
        padding: 15px;
        background: white;
        border-radius: 12px;
    }

    .event-card {
        background: linear-gradient(45deg, #FF9800, #FFB74D);
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        animation: pulse 2s infinite;
    }

    .event-title {
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 5px;
    }

    .event-desc {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 10px;
    }

    .event-score {
        background: rgba(255,255,255,0.2);
        padding: 8px;
        border-radius: 6px;
    }

    .player-score {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
    }
`;
document.head.appendChild(styleSheet);

// Thêm hàm kiểm tra và cập nhật tiến trình lặp lại
function checkIterativeProgress(childName, taskId) {
    const dateKey = getDateKey();
    const lastWeek = [];
    
    // Lấy dữ liệu 7 ngày gần nhất
    for (let i = 0; i < 7; i++) {
        const date = new Date(currentDate);
        date.setDate(date.getDate() - i);
        const key = getDateKey(date);
        if (scheduleData[childName][key] && scheduleData[childName][key].tasks) {
            const task = scheduleData[childName][key].tasks.find(t => t.id === taskId);
            if (task) {
                lastWeek.push(task.rating);
            }
        }
    }
    
    // Tính số ngày liên tiếp hoàn thành tốt
    let streak = 0;
    for (const rating of lastWeek) {
        if (rating === 'good') {
            streak++;
        } else {
            break;
        }
    }
    
    // Cập nhật hiển thị streak
    const taskElement = document.querySelector(`#${childName} .task[data-task-id="${taskId}"]`);
    if (taskElement) {
        let streakBadge = taskElement.querySelector('.streak-badge');
        if (!streakBadge) {
            streakBadge = document.createElement('div');
            streakBadge.className = 'streak-badge';
            taskElement.querySelector('.task-header').appendChild(streakBadge);
        }
        
        if (streak > 0) {
            streakBadge.innerHTML = `🔥 ${streak} ngày`;
            streakBadge.style.display = 'block';
        } else {
            streakBadge.style.display = 'none';
        }
    }
    
    return streak;
}

// Thêm style cho streak badge
const streakStyle = document.createElement('style');
streakStyle.textContent = `
    .streak-badge {
        background: linear-gradient(45deg, #FF9800, #FF5722);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin-left: 10px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.8; }
        100% { opacity: 1; }
    }
`;
document.head.appendChild(streakStyle);

// Cập nhật hàm createTaskElement để thêm data-task-id
function createTaskElement(task, childName) {
    const taskElement = document.createElement('div');
    taskElement.className = `task ${task.rating ? 'completed-' + task.rating : ''}`;
    taskElement.setAttribute('data-task-id', task.id);
    
    const template = taskTemplates[childName].find(t => t.id === task.id);
    
    taskElement.innerHTML = `
        <div class="task-header">
            <div class="task-time">${task.time}</div>
            <div class="task-name">${task.name}</div>
        </div>
        <div class="rating-buttons">
            <button class="rating-btn good-btn ${task.rating === 'good' ? 'active' : ''}" 
                    onclick="rateTask('${childName}', ${task.id}, 'good')">
                <i class="fas fa-smile"></i> ${template.ratings[0]}
            </button>
            <button class="rating-btn neutral-btn ${task.rating === 'neutral' ? 'active' : ''}" 
                    onclick="rateTask('${childName}', ${task.id}, 'neutral')">
                <i class="fas fa-meh"></i> ${template.ratings[1]}
            </button>
            <button class="rating-btn bad-btn ${task.rating === 'bad' ? 'active' : ''}" 
                    onclick="rateTask('${childName}', ${task.id}, 'bad')">
                <i class="fas fa-frown"></i> ${template.ratings[2]}
            </button>
        </div>
    `;
    
    // Kiểm tra và hiển thị streak
    setTimeout(() => checkIterativeProgress(childName, task.id), 0);
    
    return taskElement;
}

// Weekly challenge tracking
function getWeekNumber(date) {
    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
    const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
}

function updateWeeklyProgress() {
    const currentDate = new Date();
    const weekNumber = getWeekNumber(currentDate);
    const weekKey = `week_${weekNumber}`;
    
    let weeklyData = JSON.parse(localStorage.getItem(weekKey) || '{}');
    const today = currentDate.toISOString().split('T')[0];
    
    // Calculate scores for both children
    ['tridung', 'thaoVy'].forEach(child => {
        if (!weeklyData[child]) {
            weeklyData[child] = {
                totalPoints: 0,
                daysCompleted: 0,
                perfectDays: 0
            };
        }
        
        const todayTasks = JSON.parse(localStorage.getItem(`${today}_${child}`) || '[]');
        if (todayTasks.length > 0) {
            let dailyPoints = 0;
            let isPerfectDay = true;
            
            todayTasks.forEach(task => {
                const rating = parseInt(task.rating);
                if (rating === 0) dailyPoints += 3;
                else if (rating === 1) dailyPoints += 1;
                else isPerfectDay = false;
            });
            
            weeklyData[child].totalPoints += dailyPoints;
            weeklyData[child].daysCompleted += 1;
            if (isPerfectDay) weeklyData[child].perfectDays += 1;
        }
    });
    
    localStorage.setItem(weekKey, JSON.stringify(weeklyData));
    displayWeeklyProgress(weeklyData);
}

function displayWeeklyProgress(weeklyData) {
    const progressDiv = document.getElementById('weeklyProgress');
    if (!progressDiv) {
        const container = document.createElement('div');
        container.id = 'weeklyProgress';
        container.className = 'weekly-progress';
        document.body.appendChild(container);
    }
    
    const currentWeek = getWeekNumber(new Date());
    let html = `<h2>Thử thách tuần ${currentWeek}</h2>`;
    
    ['tridung', 'thaoVy'].forEach(child => {
        const childData = weeklyData[child] || { totalPoints: 0, daysCompleted: 0, perfectDays: 0 };
        const childName = child === 'tridung' ? 'Trí Dũng' : 'Thảo Vy';
        const treeImage = `images/tree_day${childData.daysCompleted || 0}.png`;
        
        html += `
            <div class="child-progress">
                <h3>${childName}</h3>
                <img src="${treeImage}" alt="Cây tiến độ" class="progress-tree">
                <p>Điểm: ${childData.totalPoints}</p>
                <p>Ngày hoàn thành: ${childData.daysCompleted}/7</p>
                <p>Ngày hoàn hảo: ${childData.perfectDays}</p>
            </div>
        `;
    });
    
    document.getElementById('weeklyProgress').innerHTML = html;
}

// Add styles for weekly progress
const styleElement = document.createElement('style');
styleElement.textContent = `
    .weekly-progress {
        margin: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .child-progress {
        display: inline-block;
        margin: 10px;
        text-align: center;
        padding: 10px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .progress-tree {
        width: 100px;
        height: auto;
        margin: 10px 0;
    }
`;
document.head.appendChild(styleElement);

// Update progress when tasks are completed
function updateTask(childId, taskId, rating) {
    // ...existing code...
    updateWeeklyProgress(); // Add this line to update weekly progress
}

// Initialize weekly progress on page load
document.addEventListener('DOMContentLoaded', function() {
    // ...existing code...
    updateWeeklyProgress();
});
</script>
</body>
</html>
