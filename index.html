<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Thời gian biểu cho bé</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<style>
        :root {
            --primary-color: #FF7043;
            --secondary-color: #FFAB91;
            --neutral-color: #FBE9E7;
            --text-color: #3E2723;
            --light-text: #795548;
            --success-color: #66BB6A;
            --warning-color: #FFCA28;
            --danger-color: #EF5350;
        }
        
        body {
            font-family: 'Baloo 2', cursive;
            margin: 0;
            padding: 0;
            background-color: var(--neutral-color);
            color: var(--text-color);
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
        }
        
        .date-container {
            background-color: white;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .date-display {
            font-size: 18px;
            font-weight: 600;
        }
        
        .date-nav {
            display: flex;
            gap: 15px;
        }
        
        .date-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .progress {
            height: 30px;
            background-color: white;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            text-align: center;
            line-height: 30px;
            color: white;
            font-weight: 600;
            transition: width 0.5s;
        }
        
        .task-list {
            margin-bottom: 20px;
        }
        
        .task {
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .task.completed-good {
            border-left: 5px solid var(--success-color);
        }
        
        .task.completed-neutral {
            border-left: 5px solid var(--warning-color);
        }
        
        .task.completed-bad {
            border-left: 5px solid var(--danger-color);
        }
        
        .task-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .task-time {
            background-color: var(--neutral-color);
            padding: 5px 10px;
            border-radius: 8px;
            font-weight: 600;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .task-name {
            font-weight: 600;
            font-size: 16px;
            flex-grow: 1;
        }
        
        .rating-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .rating-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Baloo 2', cursive;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .good-btn {
            background-color: #E8F5E9;
            color: var(--success-color);
        }
        
        .good-btn:hover, .good-btn.active {
            background-color: var(--success-color);
            color: white;
        }
        
        .neutral-btn {
            background-color: #FFF8E1;
            color: var(--warning-color);
        }
        
        .neutral-btn:hover, .neutral-btn.active {
            background-color: var(--warning-color);
            color: white;
        }
        
        .bad-btn {
            background-color: #FFEBEE;
            color: var(--danger-color);
        }
        
        .bad-btn:hover, .bad-btn.active {
            background-color: var(--danger-color);
            color: white;
        }
        
        .reward {
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #FFD54F, #FFCA28);
            border-radius: 12px;
            margin-top: 20px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }
        
        .reward.active {
            display: block;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            animation: slideDown 0.5s;
        }
        
        @keyframes slideDown {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
        
        .stats-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .stats-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .stats-modal.active {
            visibility: visible;
            opacity: 1;
        }
        
        .stats-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .stats-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--light-text);
        }
        
        .stats-chart {
            height: 200px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        
        .chart-bar {
            flex: 1;
            background-color: var(--primary-color);
            transition: height 0.5s;
            border-radius: 5px 5px 0 0;
            position: relative;
            min-width: 30px;
        }
        
        .chart-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            white-space: nowrap;
        }
        
        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: 600;
        }
        
        .stats-summary {
            margin-top: 40px;
            background-color: var(--neutral-color);
            padding: 15px;
            border-radius: 10px;
        }
        
        .sleep-record {
            display: flex;
            justify-content: space-between;
            background-color: #E8F5E9;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .sleep-record.good {
            background-color: #E8F5E9;
            border-left: 4px solid var(--success-color);
        }
        
        .sleep-record.neutral {
            background-color: #FFF8E1;
            border-left: 4px solid var(--warning-color);
        }
        
        .sleep-record.bad {
            background-color: #FFEBEE;
            border-left: 4px solid var(--danger-color);
        }
    /* Responsive design cho điện thoại */
    @media screen and (max-width: 768px) {
        body {
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 10px;
            margin: 0;
        }

        /* Điều chỉnh header */
        .header {
            margin: 0 0 15px 0;
            border-radius: 0;
        }

        .header h1 {
            font-size: 20px;
        }



        /* Điều chỉnh cây và nút tưới nước */
        div[style*="position: fixed; bottom: 500px; right: 340px;"] {
            position: static !important;
            width: 100% !important;
            margin: 10px 0;
            text-align: center;
        }

        #tree-img {
            width: 120px !important;
            height: 120px !important;
        }

        /* Điều chỉnh huy hiệu */
        div[style*="position: fixed; top: 100px; right: 20px;"] {
            position: static !important;
            width: 100% !important;
            margin: 10px 0;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Điều chỉnh tabs */
        .tabs {
            margin: 10px 0;
        }

        .tab {
            padding: 8px;
            font-size: 14px;
        }

        .tab img {
            width: 20px;
            height: 20px;
        }

        /* Điều chỉnh nhiệm vụ */
        .task {
            margin-bottom: 10px;
        }

        .task-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .task-time {
            margin-bottom: 5px;
            width: 100%;
            text-align: left;
        }

        .task-name {
            width: 100%;
        }

        .rating-buttons {
            flex-direction: column;
            gap: 5px;
        }

        .rating-btn {
            width: 100%;
            padding: 12px;
            justify-content: center;
        }

        /* Điều chỉnh hiệu ứng tưới nước */
        #watering-gif {
            width: 80px !important;
            height: auto !important;
            top: auto !important;
            left: 50% !important;
            transform: translateX(-50%);
            z-index: 1000;
        }

        /* Điều chỉnh popup chúc mừng */
        #popup-congrats {
            width: 90% !important;
            max-width: 300px;
        }

        #popup-congrats img {
            width: 150px !important;
            height: auto !important;
        }

        /* Điều chỉnh nút thống kê */
        .stats-btn {
            width: 40px;
            height: 40px;
            font-size: 20px;
            bottom: 10px;
            right: 10px;
        }

        .stats-content {
            width: 95%;
            max-width: none;
            margin: 10px;
            padding: 15px;
        }

        /* Tối ưu hiệu ứng */
        .notification {
            width: 90%;
            font-size: 14px;
            padding: 10px;
        }

        /* Tối ưu scrolling */
        html {
            scroll-behavior: smooth;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }
    }
</style>
</head>
<body>
    


<!-- Thêm vào phần JavaScript để xử lý chuyển đổi hiển thị -->
<script>
// Cập nhật hàm switchTab để hiển thị đúng profile
let originalSwitchTab;
if (typeof switchTab !== 'undefined') {
    originalSwitchTab = switchTab;
    switchTab = function(childName) {
        originalSwitchTab(childName);
        updateLevelDisplay();
        
        // Ẩn/hiện profile tương ứng
        document.getElementById('tridung-profile').style.display = childName === 'tridung' ? 'block' : 'none';
        document.getElementById('thaoVy-profile').style.display = childName === 'thaoVy' ? 'block' : 'none';
    };
}
</script>
<div class="container">
<div class="header">
<h1>Thời gian biểu cho bé</h1>
</div>
<div class="date-container">
<div class="date-display" id="currentDate">Hôm nay, 17/04/2025</div>
<div class="date-nav">
<button class="date-btn" onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
<button class="date-btn" onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('tridung')">
        <img src="images/vit.jpg" style="width:30px; height:30px; border-radius:50%; margin-right:5px; vertical-align:middle;">
        Trí Dũng (5 tuổi)
    </div>
    <div class="tab" onclick="switchTab('thaoVy')">
        <img src="images/vy.jpg" style="width:30px; height:30px; border-radius:50%; margin-right:5px; vertical-align:middle;">
        Thảo Vy (3 tuổi)
    </div>
</div>

<style>
.tab {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    /* ...existing styles... */
}

.tab img {
    transition: transform 0.3s ease;
}

.tab:hover img {
    transform: scale(1.1);
}

.tab.active img {
    border: 2px solid #fff;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}
</style>

<div class="progress">
<div class="progress-bar" id="progressBar" style="width: 0%">0/16 điểm</div>
</div>
<div class="child-tab" id="tridung">
<div class="sleep-record" id="sleepRecord">
<div><i class="fas fa-bed"></i> Ngủ đêm qua:</div>
<div id="sleepStatus">Chưa có dữ liệu</div>
</div>
<div class="task-list">
<!-- Tasks will be added here dynamically -->
</div>
</div>
<div class="child-tab" id="thaoVy" style="display:none">
<div class="sleep-record" id="sleepRecordThaoVy">
<div><i class="fas fa-bed"></i> Ngủ đêm qua:</div>
<div id="sleepStatusThaoVy">Chưa có dữ liệu</div>
</div>
<div class="task-list">
<!-- Tasks will be added here dynamically -->
</div>
</div>
<div class="reward" id="reward">
<i class="fas fa-trophy"></i> Chúc mừng! Bé đã hoàn thành nhiệm vụ và được phép chơi thiết bị điện tử từ 20:00 - 21:00
        </div>
</div>
<div class="notification" id="notification">
<i class="fas fa-bell"></i> Đến giờ thực hiện nhiệm vụ mới!
    </div>
<button class="stats-btn" onclick="toggleStats()">
<i class="fas fa-chart-bar"></i>
</button>
<div class="stats-modal" id="statsModal">
<div class="stats-content">
<div class="stats-header">
<h2>Thống kê hoạt động</h2>
<button class="stats-close" onclick="toggleStats()"><i class="fas fa-times"></i></button>
</div>
<div class="stats-chart" id="statsChart">
<!-- Chart bars will be added here -->
</div>
<div class="stats-summary">
<h3>Tóm tắt 7 ngày qua</h3>
<p><strong>Tổng điểm:</strong> <span id="totalPoints">0</span> điểm</p>
<p><strong>Điểm trung bình:</strong> <span id="averagePoints">0</span> điểm/ngày</p>
<p><strong>Ngày tốt nhất:</strong> <span id="bestDay">Chưa có dữ liệu</span></p>
<p><strong>Số ngày được chơi thiết bị:</strong> <span id="deviceDays">0</span>/7 ngày</p>
</div>
</div>
</div>
<script>
        // Thiết lập ngày hiện tại
        let currentDate = new Date();
        let currentChild = 'tridung';
        
        // Dữ liệu lưu trữ
        const storageKey = 'kidScheduleData';
        let scheduleData = {
            tridung: {},
            thaoVy: {}
        };
        
        // Hạng mục đánh giá
        const ratingValues = {
            good: 3,
            neutral: 1,
            bad: 0
        };
        
        // Danh sách nhiệm vụ cố định
        const taskTemplates = {
            tridung: [
                { id: 1, time: "21:00", name: "Đi ngủ (đêm qua)", isPreviousSleep: true, ratings: ["Đúng giờ", "Trễ giờ", "Không ngủ"] },
                { id: 2, time: "6:30 - 7:00", name: "Thức dậy, vệ sinh cá nhân, đi học", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
                { id: 3, time: "17:00 - 18:00", name: "Chơi tự do", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
                { id: 4, time: "18:00 - 18:30", name: "Ăn tối tại nhà", ratings: ["Ăn nhanh và nhiều", "Ăn chậm", "Không chịu ăn"] },
                { id: 5, time: "18:30 - 19:00", name: "Vệ sinh cá nhân buổi tối", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
                { id: 6, time: "19:00 - 20:00", name: "Đọc sách, tô màu hoặc làm toán", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
                { id: 7, time: "21:00", name: "Đi ngủ", ratings: ["Đúng giờ", "Trễ giờ", "Không ngủ"] }
            ],
            thaoVy: [
                { id: 1, time: "21:00", name: "Đi ngủ (đêm qua)", isPreviousSleep: true, ratings: ["Đúng giờ", "Trễ giờ", "Không ngủ"] },
                { id: 2, time: "6:30 - 7:00", name: "Thức dậy, vệ sinh cá nhân, đi học", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
                { id: 3, time: "17:00 - 18:00", name: "Chơi tự do", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
                { id: 4, time: "18:00 - 18:30", name: "Ăn tối tại nhà", ratings: ["Ăn nhanh và nhiều", "Ăn chậm", "Không chịu ăn"] },
                { id: 5, time: "18:30 - 19:00", name: "Vệ sinh cá nhân buổi tối", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
                { id: 6, time: "19:00 - 20:00", name: "Đọc sách, tô màu", ratings: ["Tốt", "Chưa được tốt", "Chưa tốt"] },
                { id: 7, time: "21:00", name: "Đi ngủ", ratings: ["Đúng giờ", "Trễ giờ", "Không ngủ"] }
            ]
        };
        
        // Hiển thị ngày hiện tại
        function updateDateDisplay() {
            const options = { weekday: 'long', day: 'numeric', month: 'numeric', year: 'numeric' };
            const dateString = currentDate.toLocaleDateString('vi-VN', options);
            const capitalizedDate = dateString.charAt(0).toUpperCase() + dateString.slice(1);
            document.getElementById('currentDate').textContent = capitalizedDate;
        }
        
        // Đổi ngày
        function changeDate(delta) {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + delta);
            currentDate = newDate;
            updateDateDisplay();
            renderTasks();
            updateSleepRecord();
            checkReward();
        }
        
        // Lấy key cho ngày hiện tại
        function getDateKey(date = currentDate) {
            return date.toISOString().split('T')[0];
        }
        
        // Lấy key cho ngày hôm trước
        function getPreviousDateKey() {
            const prevDate = new Date(currentDate);
            prevDate.setDate(prevDate.getDate() - 1);
            return getDateKey(prevDate);
        }
        
        // Cập nhật trạng thái ngủ của ngày hôm trước
        function updateSleepRecord() {
            const prevDateKey = getPreviousDateKey();
            const currentDateKey = getDateKey();
            
            // Kiểm tra trạng thái ngủ cho Trí Dũng
            const sleepStatus = document.getElementById('sleepStatus');
            if (scheduleData.tridung[prevDateKey] && scheduleData.tridung[prevDateKey].tasks) {
                const sleepTask = scheduleData.tridung[prevDateKey].tasks.find(t => t.id === 7);
                if (sleepTask && sleepTask.rating) {
                    sleepStatus.textContent = sleepTask.rating === 'good' ? 'Tốt' : 
                                              sleepTask.rating === 'neutral' ? 'Trễ giờ' : 'Không ngủ';
                    
                    const sleepRecord = document.getElementById('sleepRecord');
                    sleepRecord.className = 'sleep-record ' + sleepTask.rating;
                } else {
                    sleepStatus.textContent = 'Chưa có dữ liệu';
                    document.getElementById('sleepRecord').className = 'sleep-record';
                }
            } else {
                sleepStatus.textContent = 'Chưa có dữ liệu';
                document.getElementById('sleepRecord').className = 'sleep-record';
            }
            
            // Kiểm tra trạng thái ngủ cho Thảo Vy
            const sleepStatusThaoVy = document.getElementById('sleepStatusThaoVy');
            if (scheduleData.thaoVy[prevDateKey] && scheduleData.thaoVy[prevDateKey].tasks) {
                const sleepTaskThaoVy = scheduleData.thaoVy[prevDateKey].tasks.find(t => t.id === 7);
                if (sleepTaskThaoVy && sleepTaskThaoVy.rating) {
                    sleepStatusThaoVy.textContent = sleepTaskThaoVy.rating === 'good' ? 'Tốt' : 
                                                  sleepTaskThaoVy.rating === 'neutral' ? 'Trễ giờ' : 'Không ngủ';
                    
                    const sleepRecordThaoVy = document.getElementById('sleepRecordThaoVy');
                    sleepRecordThaoVy.className = 'sleep-record ' + sleepTaskThaoVy.rating;
                } else {
                    sleepStatusThaoVy.textContent = 'Chưa có dữ liệu';
                    document.getElementById('sleepRecordThaoVy').className = 'sleep-record';
                }
            } else {
                sleepStatusThaoVy.textContent = 'Chưa có dữ liệu';
                document.getElementById('sleepRecordThaoVy').className = 'sleep-record';
            }
            
            // Chuẩn bị dữ liệu cho ngày hiện tại nếu chưa có
            ['tridung', 'thaoVy'].forEach(child => {
                if (!scheduleData[child][currentDateKey]) {
                    scheduleData[child][currentDateKey] = {
                        tasks: [],
                        totalPoints: 0
                    };
                    
                    // Tạo các nhiệm vụ từ template
                    scheduleData[child][currentDateKey].tasks = taskTemplates[child].map(template => {
                        return {
                            id: template.id,
                            time: template.time,
                            name: template.name,
                            isPreviousSleep: template.isPreviousSleep || false,
                            rating: null
                        };
                    });
                }
            });
        }
        
        // Hiển thị danh sách nhiệm vụ
        function renderTasks() {
            const dateKey = getDateKey();
            
            // Render nhiệm vụ cho Trí Dũng
            const tridungTaskList = document.querySelector('#tridung .task-list');
            tridungTaskList.innerHTML = '';
            
            if (scheduleData.tridung[dateKey] && scheduleData.tridung[dateKey].tasks) {
                // Lọc ra nhiệm vụ của ngày hiện tại (không phải ngủ của ngày hôm trước)
                const currentTasks = scheduleData.tridung[dateKey].tasks.filter(task => !task.isPreviousSleep);
                
                currentTasks.forEach(task => {
                    const taskElement = createTaskElement(task, 'tridung');
                    tridungTaskList.appendChild(taskElement);
                });
            }
            
            // Render nhiệm vụ cho Thảo Vy
            const thaoVyTaskList = document.querySelector('#thaoVy .task-list');
            thaoVyTaskList.innerHTML = '';
            
            if (scheduleData.thaoVy[dateKey] && scheduleData.thaoVy[dateKey].tasks) {
                // Lọc ra nhiệm vụ của ngày hiện tại (không phải ngủ của ngày hôm trước)
                const currentTasks = scheduleData.thaoVy[dateKey].tasks.filter(task => !task.isPreviousSleep);
                
                currentTasks.forEach(task => {
                    const taskElement = createTaskElement(task, 'thaoVy');
                    thaoVyTaskList.appendChild(taskElement);
                });
            }
            
            updateProgress();
        }
        
        // Tạo phần tử nhiệm vụ
        function createTaskElement(task, childName) {
            const taskElement = document.createElement('div');
            taskElement.className = `task ${task.rating ? 'completed-' + task.rating : ''}`;
            
            const template = taskTemplates[childName].find(t => t.id === task.id);
            
            taskElement.innerHTML = `
                <div class="task-header">
                    <div class="task-time">${task.time}</div>
                    <div class="task-name">${task.name}</div>
                </div>
                <div class="rating-buttons">
                    <button class="rating-btn good-btn ${task.rating === 'good' ? 'active' : ''}" 
                            onclick="rateTask('${childName}', ${task.id}, 'good')">
                        <i class="fas fa-smile"></i> ${template.ratings[0]}
                    </button>
                    <button class="rating-btn neutral-btn ${task.rating === 'neutral' ? 'active' : ''}" 
                            onclick="rateTask('${childName}', ${task.id}, 'neutral')">
                        <i class="fas fa-meh"></i> ${template.ratings[1]}
                    </button>
                    <button class="rating-btn bad-btn ${task.rating === 'bad' ? 'active' : ''}" 
                            onclick="rateTask('${childName}', ${task.id}, 'bad')">
                        <i class="fas fa-frown"></i> ${template.ratings[2]}
                    </button>
                </div>
            `;
            
            return taskElement;
        }
        
        
        // Tính lại tổng điểm
        function recalculateTotalPoints(childName, dateKey) {
            let totalPoints = 0;
            
            if (scheduleData[childName][dateKey] && scheduleData[childName][dateKey].tasks) {
                scheduleData[childName][dateKey].tasks.forEach(task => {
                    if (task.rating) {
                        totalPoints += ratingValues[task.rating];
                    }
                });
scheduleData[childName][dateKey].totalPoints = totalPoints;
            }
        }
        
        // Cập nhật thanh tiến trình
        function updateProgress() {
            const dateKey = getDateKey();
            const childData = scheduleData[currentChild][dateKey];
            
            if (childData) {
                const totalPoints = childData.totalPoints || 0;
                const maxPoints = taskTemplates[currentChild].length * 3;
                const progressPercent = (totalPoints / maxPoints) * 100;
                
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = `${progressPercent}%`;
                progressBar.textContent = `${totalPoints}/${maxPoints} điểm`;
            }
        }
        
        // Kiểm tra xem có đạt yêu cầu nhận phần thưởng không
        function checkReward() {
            const dateKey = getDateKey();
            const prevDateKey = getPreviousDateKey();
            
            // Kiểm tra xem có dữ liệu cho ngày hiện tại và ngày hôm trước không
            if (!scheduleData[currentChild][dateKey] || !scheduleData[currentChild][prevDateKey]) {
                document.getElementById('reward').classList.remove('active');
                return;
            }
            
            // Kiểm tra đánh giá ngủ của ngày hôm trước
            const previousSleepTask = scheduleData[currentChild][prevDateKey].tasks.find(t => t.id === 7);
            const goodSleepYesterday = previousSleepTask && (previousSleepTask.rating === 'good' || previousSleepTask.rating === 'neutral');
            
            // Kiểm tra tổng điểm của ngày hôm nay (cần đạt ít nhất 12 điểm)
            const goodPointsToday = scheduleData[currentChild][dateKey].totalPoints >= 12;
            
            // Hiển thị phần thưởng nếu đủ điều kiện
            const rewardElement = document.getElementById('reward');
            if (goodSleepYesterday && goodPointsToday) {
                rewardElement.classList.add('active');
            } else {
                rewardElement.classList.remove('active');
            }
        }
        
        // Chuyển đổi giữa các tab
        function switchTab(childName) {
            currentChild = childName;
            
            // Cập nhật trạng thái tab
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`.tab[onclick="switchTab('${childName}')"]`);
            activeTab.classList.add('active');
            
            // Hiển thị tab con tương ứng
            const childTabs = document.querySelectorAll('.child-tab');
            childTabs.forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Sửa tên biến cho đúng - thaoVy thành thaoVy
            document.getElementById(childName === 'tridung' ? 'tridung' : 'thaoVy').style.display = 'block';
            
            // Ẩn/hiện profile tương ứng
            document.getElementById('tridung-profile').style.display = childName === 'tridung' ? 'block' : 'none';
            document.getElementById('thaoVy-profile').style.display = childName === 'thaoVy' ? 'block' : 'none';
            
            // Cập nhật tiến trình và trạng thái phần thưởng
            updateProgress();
            checkReward();
        }
        
        // Hiển thị thông báo
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.innerHTML = `<i class="fas fa-bell"></i> ${message}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Kiểm tra thông báo dựa trên thời gian
        function checkTaskNotifications() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            const dateKey = getDateKey();
            
            // Kiểm tra cả hai bé
            ['tridung', 'thaoVy'].forEach(childName => {
                if (scheduleData[childName][dateKey] && scheduleData[childName][dateKey].tasks) {
                    scheduleData[childName][dateKey].tasks.forEach(task => {
                        if (!task.isPreviousSleep) { // Bỏ qua nhiệm vụ ngủ của ngày hôm trước
                            const timeRange = task.time.split(' - ');
                            if (timeRange.length > 1) {
                                const startTime = timeRange[0].split(':');
                                const startHour = parseInt(startTime[0]);
                                const startMinute = parseInt(startTime[1]);
                                
                                if (hours === startHour && minutes === startMinute && !task.rating) {
                                    showNotification(`${childName === 'tridung' ? 'Trí Dũng' : 'Thảo Vy'}: Đến giờ ${task.name}`);
                                }
                            } else if (timeRange[0].includes(':')) {
                                const exactTime = timeRange[0].split(':');
                                const exactHour = parseInt(exactTime[0]);
                                const exactMinute = parseInt(exactTime[1]);
                                
                                if (hours === exactHour && minutes === exactMinute && !task.rating) {
                                    showNotification(`${childName === 'tridung' ? 'Trí Dũng' : 'Thảo Vy'}: Đến giờ ${task.name}`);
                                }
                            }
                        }
                    });
                }
            });
        }
        
        // Hiển thị/ẩn modal thống kê
        function toggleStats() {
            const statsModal = document.getElementById('statsModal');
            statsModal.classList.toggle('active');
            
            if (statsModal.classList.contains('active')) {
                updateStats();
            }
        }
        
        // Cập nhật thống kê
        function updateStats() {
            const statsChart = document.getElementById('statsChart');
            statsChart.innerHTML = '';
            
            // Lấy dữ liệu 7 ngày gần nhất
            const last7Days = [];
            let totalPoints = 0;
            let deviceDays = 0;
            let bestDay = { date: null, points: 0 };
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - i);
                const dateKey = getDateKey(date);
                
                // Format ngày hiển thị
                const dayDisplay = date.getDate() + '/' + (date.getMonth() + 1);
                
                // Dữ liệu điểm
                let dayPoints = 0;
                if (scheduleData[currentChild][dateKey] && scheduleData[currentChild][dateKey].totalPoints) {
                    dayPoints = scheduleData[currentChild][dateKey].totalPoints;
                }
                
                // Thêm vào tổng điểm
                totalPoints += dayPoints;
                
                // Kiểm tra ngày tốt nhất
                if (dayPoints > bestDay.points) {
                    bestDay = {
                        date: new Date(date),
                        points: dayPoints
                    };
                }
                
                // Kiểm tra xem ngày đó có được chơi thiết bị không
                const prevDate = new Date(date);
                prevDate.setDate(prevDate.getDate() - 1);
                const prevDateKey = getDateKey(prevDate);
                
                // Điều kiện được chơi thiết bị: Ngủ tốt ngày hôm trước + điểm cao ngày hôm nay
                let canUseDevice = false;
                
                if (scheduleData[currentChild][prevDateKey] && scheduleData[currentChild][dateKey]) {
                    const previousSleepTask = scheduleData[currentChild][prevDateKey].tasks?.find(t => t.id === 7);
                    const goodSleepYesterday = previousSleepTask && (previousSleepTask.rating === 'good' || previousSleepTask.rating === 'neutral');
                    const goodPointsToday = dayPoints >= 12;
                    
                    canUseDevice = goodSleepYesterday && goodPointsToday;
                    if (canUseDevice) deviceDays++;
                }
                
                // Thêm vào mảng dữ liệu
                last7Days.push({
                    date: dayDisplay,
                    points: dayPoints,
                    canUseDevice: canUseDevice
                });
            }
            
            // Tạo biểu đồ
            last7Days.forEach(day => {
                // Tính chiều cao dựa trên điểm (tối đa 21 điểm ~ chiều cao 100%)
                const heightPercent = (day.points / 21) * 100;
                
                const barElement = document.createElement('div');
                barElement.className = `chart-bar ${day.canUseDevice ? 'good-btn' : ''}`;
                barElement.style.height = `${heightPercent}%`;
                
                barElement.innerHTML = `
                    <div class="chart-bar-value">${day.points}</div>
                    <div class="chart-bar-label">${day.date}</div>
                `;
                
                statsChart.appendChild(barElement);
            });
            
            // Cập nhật tóm tắt thống kê
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('averagePoints').textContent = (totalPoints / 7).toFixed(1);
            document.getElementById('deviceDays').textContent = deviceDays;
            
            if (bestDay.date) {
                const options = { weekday: 'long', day: 'numeric', month: 'numeric' };
                const bestDayStr = bestDay.date.toLocaleDateString('vi-VN', options);
                document.getElementById('bestDay').textContent = `${bestDayStr} (${bestDay.points} điểm)`;
            } else {
                document.getElementById('bestDay').textContent = 'Chưa có dữ liệu';
            }
        }
        


// Sửa hàm saveData để lưu dữ liệu cây
// Hàm lưu dữ liệu
function saveData() {
    localStorage.setItem(storageKey, JSON.stringify(scheduleData));
    
    // Lưu dữ liệu cây
    localStorage.setItem('treeData', JSON.stringify({
        waterCredits: waterCredits,
        treeLevel: treeLevel
    }));
}
function updateTreeImage() {
    // Xác định cấp độ cây dựa vào ngày trong tuần
    const weekDay = new Date().getDay(); // 0: Chủ Nhật, 1: Thứ 2...
    
    // Nếu là chủ nhật, hiển thị cây trưởng thành
    if (weekDay === 0) {
        document.getElementById("tree-img").src = "images/tree_day7.png";
        document.getElementById("tree-status").textContent = "Cây đã trưởng thành hoàn toàn! Chúc mừng bé!";
        document.getElementById("tree-status").style.color = "#4CAF50";
    } else {
        // Các ngày khác trong tuần, hiển thị theo tiến độ
        // Thứ 2 (1) -> cấp độ 1, Thứ 3 (2) -> cấp độ 2, ..., Thứ 7 (6) -> cấp độ 6
        const expectedLevel = weekDay; // Cấp độ mong đợi cho ngày hiện tại
        
        // Hiển thị cây theo cấp độ thực tế (không vượt quá cấp độ mong đợi)
        const displayLevel = Math.min(treeLevel, expectedLevel);
        document.getElementById("tree-img").src = `images/tree_day${displayLevel}.png`;
        
        // Hiển thị thông báo về trạng thái cây
        if (treeLevel < expectedLevel) {
            document.getElementById("tree-status").textContent = "Cây cần thêm nước để phát triển!";
            document.getElementById("tree-status").style.color = "#FF9800";
        } else {
            document.getElementById("tree-status").textContent = "Cây đang phát triển tốt!";
            document.getElementById("tree-status").style.color = "#4CAF50";
        }
    }
}

// Hàm tải dữ liệu
function loadData() {
    const savedData = localStorage.getItem(storageKey);
    if (savedData) {
        scheduleData = JSON.parse(savedData);
    }
    
    // Tải dữ liệu cây
    const treeData = localStorage.getItem('treeData');
    if (treeData) {
        const parsedTreeData = JSON.parse(treeData);
        waterCredits = parsedTreeData.waterCredits || 0;
        treeLevel = parsedTreeData.treeLevel || 1;
        
        // Cập nhật UI
        document.getElementById("water-units").textContent = waterCredits;
        updateTreeImage();
        
        console.log("Đã tải dữ liệu: lượt tưới =", waterCredits, "cấp độ cây =", treeLevel);
    }
    
    // Lấy ngày trong tuần hiện tại
    currentWeekDay = new Date().getDay(); // 0: Chủ Nhật, 1: Thứ 2...
    
    // Khởi tạo ngày hiện tại nếu chưa có
    initializeCurrentDate();
    checkAndResetTree();
    updateDateDisplay();
    updateSleepRecord();
    renderTasks();
    checkReward();
}
        
        // Khởi tạo dữ liệu cho ngày hiện tại nếu chưa có
        function initializeCurrentDate() {
            const dateKey = getDateKey();
            
            ['tridung', 'thaoVy'].forEach(child => {
                if (!scheduleData[child][dateKey]) {
                    scheduleData[child][dateKey] = {
                        tasks: [],
                        totalPoints: 0
                    };
                    
                    // Tạo các nhiệm vụ từ template
                    scheduleData[child][dateKey].tasks = taskTemplates[child].map(template => {
                        return {
                            id: template.id,
                            time: template.time,
                            name: template.name,
                            isPreviousSleep: template.isPreviousSleep || false,
                            rating: null
                        };
                    });
                }
            });
        }
        
        // Kiểm tra thông báo mỗi phút
        setInterval(checkTaskNotifications, 60000);
        
        // Thêm sự kiện lưu dữ liệu
        window.addEventListener('beforeunload', saveData);
        
        // Khởi chạy ứng dụng
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
<div id="popup-congrats" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%, -50%); z-index:9999; text-align:center;">
<img alt="Mẹ Quỳnh" src="images/me_quynh.jpg" style="width:250px; border-radius:10px; box-shadow: 0 0 10px #888;"/>
<div id="popup-text" style="background:white; padding:10px; font-weight:bold; font-size:18px; margin-top:-5px;">Bé làm tốt lắm!</div>
</div>
<audio id="audio-congrats" preload="auto" src=""></audio>
<img id="watering-gif" src="images/water.gif" style="display:none; position:absolute; width:120px; top:350px; left:1190px; z-index:10;"/>

<!-- THÊM ĐOẠN NÀY -->
<div style="position: fixed; bottom: 500px; right: 340px; text-align: center; z-index: 50;">
    <img id="tree-img" src="images/tree_day1.png" style="width:150px; height:150px;">
    <div id="tree-status" style="font-weight:bold; color:#FF9800; margin:5px 0;">
        Cây cần nước để phát triển!
    </div>
    <div style="margin-top:5px; margin-bottom:10px;">
        <span id="water-count" style="font-weight:bold; color:#2196F3;">💧 <span id="water-units">0</span> lượt tưới</span>
    </div>
    <button onclick="waterTree()">💧 Bé tưới nước cho cây</button>
</div>

<!-- Thêm khu vực hiển thị huy hiệu -->
<div style="position: fixed; top: 100px; right: 20px; text-align: center; background-color: rgba(255,255,255,0.8); padding: 10px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0; color: #FF6D00;">Huy hiệu của bé</h3>
    <div id="badges-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; max-width: 150px;">
        <!-- Huy hiệu sẽ được thêm vào đây -->
    </div>
</div>
<script>
// Định nghĩa các loại huy hiệu
const badges = [
    { id: 'star3', name: '3 Ngày Sao Vàng', image: '⭐⭐⭐', condition: 'Hoàn thành tốt 3 ngày liên tiếp' },
    { id: 'sleep7', name: 'Ngủ Ngoan 7 Ngày', image: '😴🥇', condition: 'Đi ngủ đúng giờ 7 ngày liên tiếp' },
    { id: 'tree', name: 'Người Trồng Cây', image: '🌳👑', condition: 'Cây phát triển đầy đủ' },
    { id: 'eat5', name: 'Ăn Giỏi 5 Ngày', image: '🍽️🏆', condition: 'Ăn tối ngoan 5 ngày liên tiếp' }
];

// Hàm kiểm tra và cấp huy hiệu mới
function checkAndAwardBadges() {
    // Lấy danh sách huy hiệu đã có
    let earnedBadges = JSON.parse(localStorage.getItem('earnedBadges') || '{}');
    
    // Kiểm tra điều kiện cấp huy hiệu mới
    
    // Ví dụ: Huy hiệu 3 ngày sao vàng
    let consecutiveGoodDays = 0;
    for (let i = 0; i < 3; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateKey = getDateKey(date);
        
        if (scheduleData[currentChild][dateKey] && scheduleData[currentChild][dateKey].totalPoints >= 15) {
            consecutiveGoodDays++;
        } else {
            break;
        }
    }
    
    if (consecutiveGoodDays >= 3 && !earnedBadges['star3']) {
        // Cấp huy hiệu mới
        earnedBadges['star3'] = {
            dateAwarded: new Date().toISOString(),
            forChild: currentChild
        };
        
        // Hiệu ứng thông báo huy hiệu mới
        showBadgeAward('star3');
    }
    
    // Lưu danh sách huy hiệu
    localStorage.setItem('earnedBadges', JSON.stringify(earnedBadges));
    
    // Cập nhật hiển thị huy hiệu
    renderBadges();
}

// Hiệu ứng hiển thị huy hiệu mới
function showBadgeAward(badgeId) {
    const badge = badges.find(b => b.id === badgeId);
    if (!badge) return;
    
    // Tạo phần tử thông báo
    const notification = document.createElement('div');
    notification.style.position = 'fixed';
    notification.style.top = '50%';
    notification.style.left = '50%';
    notification.style.transform = 'translate(-50%, -50%)';
    notification.style.background = 'linear-gradient(45deg, #FF9800, #FF5722)';
    notification.style.color = 'white';
    notification.style.padding = '20px';
    notification.style.borderRadius = '15px';
    notification.style.boxShadow = '0 5px 30px rgba(0,0,0,0.3)';
    notification.style.textAlign = 'center';
    notification.style.zIndex = '10000';
    notification.style.fontSize = '24px';
    notification.style.animation = 'badgeWiggle 1s infinite';
    
    // Thêm style animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes badgeWiggle {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-5deg); }
            75% { transform: translate(-50%, -50%) rotate(5deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }
        
        @keyframes badgeFade {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
    `;
    document.head.appendChild(style);
    
    // Nội dung thông báo
    notification.innerHTML = `
        <div style="font-size: 72px; margin-bottom: 10px;">${badge.image}</div>
        <div style="font-weight: bold; margin-bottom: 10px;">🎉 CHÚC MỪNG BÉ! 🎉</div>
        <div>Bé đã đạt được huy hiệu mới:</div>
        <div style="font-weight: bold; font-size: 28px; margin: 10px 0;">${badge.name}</div>
        <div>${badge.condition}</div>
        <button style="margin-top: 20px; padding: 10px 20px; background: white; color: #FF5722; border: none; border-radius: 30px; font-weight: bold; cursor: pointer;">Cảm ơn</button>
    `;
    
    // Thêm vào body
    document.body.appendChild(notification);
    
    // Xử lý sự kiện nút đóng
    notification.querySelector('button').addEventListener('click', () => {
        notification.style.animation = 'badgeFade 0.5s forwards';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 500);
    });
    
    // Tự động đóng sau 10 giây
    setTimeout(() => {
        if (document.body.contains(notification)) {
            notification.style.animation = 'badgeFade 0.5s forwards';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 500);
        }
    }, 10000);
    
    // Phát âm thanh vui nhộn
    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/218/218-preview.mp3');
    audio.play().catch(e => console.warn("Không thể phát âm thanh:", e));
}
// Thêm vào phần đầu script
let childLevel = {
    tridung: 1,
    thaoVy: 1
};

// Kiểm tra và nâng cấp
function checkAndUpgradeLevel() {
    // Đọc dữ liệu cấp độ từ localStorage nếu có
    const savedLevels = localStorage.getItem('childLevels');
    if (savedLevels) {
        childLevel = JSON.parse(savedLevels);
    }
    
    // Tính tổng điểm của 7 ngày gần nhất
    let weeklyPoints = 0;
    for (let i = 0; i < 7; i++) {
        const date = new Date(currentDate);
        date.setDate(date.getDate() - i);
        const dateKey = getDateKey(date);
        
        if (scheduleData[currentChild][dateKey] && scheduleData[currentChild][dateKey].totalPoints) {
            weeklyPoints += scheduleData[currentChild][dateKey].totalPoints;
        }
    }
    
    // Tính cấp độ mới dựa trên tổng điểm
    const newLevel = Math.floor(weeklyPoints / 30) + 1;
    
    // Nếu cấp độ tăng
    if (newLevel > childLevel[currentChild]) {
        // Cập nhật cấp độ
        const oldLevel = childLevel[currentChild];
        childLevel[currentChild] = newLevel;
        
        // Lưu vào localStorage
        localStorage.setItem('childLevels', JSON.stringify(childLevel));
        
        // Hiển thị thông báo nâng cấp
        showLevelUpNotification(oldLevel, newLevel);
        
        // Cập nhật hiển thị
        updateLevelDisplay();
    }
}

// Hiển thị thông báo nâng cấp
function showLevelUpNotification(oldLevel, newLevel) {
    // Tạo phần tử thông báo
    const notification = document.createElement('div');
    notification.style.position = 'fixed';
    notification.style.top = '50%';
    notification.style.left = '50%';
    notification.style.transform = 'translate(-50%, -50%)';
    notification.style.background = 'linear-gradient(45deg, #4CAF50, #8BC34A)';
    notification.style.color = 'white';
    notification.style.padding = '20px';
    notification.style.borderRadius = '15px';
    notification.style.boxShadow = '0 5px 30px rgba(0,0,0,0.3)';
    notification.style.textAlign = 'center';
    notification.style.zIndex = '10000';
    
    // Nội dung thông báo
    notification.innerHTML = `
        <div style="font-size: 72px; margin-bottom: 10px;">🎉</div>
        <div style="font-weight: bold; margin-bottom: 10px;">CHÚC MỪNG BÉ!</div>
        <div>Bé đã lên cấp!</div>
        <div style="display: flex; align-items: center; justify-content: center; margin: 20px 0;">
            <div style="font-size: 24px; margin-right: 20px;">Cấp ${oldLevel}</div>
            <div style="font-size: 24px;">➡️</div>
            <div style="font-size: 36px; font-weight: bold; margin-left: 20px;">Cấp ${newLevel}</div>
        </div>
        <div>Hãy tiếp tục cố gắng nhé!</div>
        <button style="margin-top: 20px; padding: 10px 20px; background: white; color: #4CAF50; border: none; border-radius: 30px; font-weight: bold; cursor: pointer;">Cảm ơn</button>
    `;
    
    // Thêm vào body
    document.body.appendChild(notification);
    
    // Xử lý sự kiện nút đóng
    notification.querySelector('button').addEventListener('click', () => {
        document.body.removeChild(notification);
    });
    
    // Phát âm thanh chúc mừng
    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/220/220-preview.mp3');
    audio.play().catch(e => console.warn("Không thể phát âm thanh:", e));
    
    // Hiệu ứng pháo hoa
    createFireworks();
}

// Cập nhật hiển thị cấp độ
function updateLevelDisplay() {
    // Kiểm tra nếu phần tử hiển thị cấp độ chưa tồn tại, tạo mới
    if (!document.getElementById('child-level-display')) {
        const levelDisplay = document.createElement('div');
        levelDisplay.id = 'child-level-display';
        levelDisplay.style.position = 'fixed';
        levelDisplay.style.top = '70px';
        levelDisplay.style.left = '20px';
        levelDisplay.style.background = 'linear-gradient(45deg, #673AB7, #3F51B5)';
        levelDisplay.style.color = 'white';
        levelDisplay.style.padding = '5px 15px';
        levelDisplay.style.borderRadius = '20px';
        levelDisplay.style.fontWeight = 'bold';
        levelDisplay.style.zIndex = '999';
        document.body.appendChild(levelDisplay);
    }
    
    // Cập nhật nội dung
    const levelDisplay = document.getElementById('child-level-display');
    levelDisplay.innerHTML = `${currentChild === 'tridung' ? 'Trí Dũng' : 'Thảo Vy'} - Cấp ${childLevel[currentChild]}`;
}
// Hiển thị huy hiệu đã đạt được
function renderBadges() {
    const container = document.getElementById('badges-container');
    container.innerHTML = '';
    
    const earnedBadges = JSON.parse(localStorage.getItem('earnedBadges') || '{}');
    
    // Lọc huy hiệu của bé hiện tại
    const childBadges = Object.keys(earnedBadges)
        .filter(badgeId => earnedBadges[badgeId].forChild === currentChild)
        .map(badgeId => badges.find(b => b.id === badgeId))
        .filter(badge => !!badge);
    
    if (childBadges.length === 0) {
        container.innerHTML = '<div style="color: #757575; font-style: italic;">Bé chưa có huy hiệu nào</div>';
        return;
    }
    
    // Hiển thị huy hiệu
    childBadges.forEach(badge => {
        const badgeElement = document.createElement('div');
        badgeElement.style.fontSize = '24px';
        badgeElement.style.cursor = 'pointer';
        badgeElement.title = `${badge.name}: ${badge.condition}`;
        badgeElement.innerHTML = badge.image;
        
        badgeElement.addEventListener('click', () => {
            alert(`Huy hiệu: ${badge.name}\n${badge.condition}`);
        });
        
        container.appendChild(badgeElement);
    });
}
// Đánh giá nhiệm vụ





// Tạo hiệu ứng confetti nhỏ
function createSmallConfetti(element) {
    const rect = element.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;

    for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'fixed';
        confetti.style.width = '8px';
        confetti.style.height = '8px';
        confetti.style.backgroundColor = getRandomColor();
        confetti.style.left = `${centerX}px`;
        confetti.style.top = `${centerY}px`;
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        confetti.style.opacity = '1';
        confetti.style.zIndex = '9999';
        confetti.style.pointerEvents = 'none';
        document.body.appendChild(confetti);

        const angle = Math.random() * Math.PI * 2;
        const distance = 20 + Math.random() * 80;
        const duration = 0.5 + Math.random() * 1;

        confetti.style.transition = `transform ${duration}s ease-out, opacity ${duration}s ease-out`;

        setTimeout(() => {
            confetti.style.transform = `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) rotate(${Math.random() * 360}deg)`;
            confetti.style.opacity = '0';
        }, 10);

        setTimeout(() => {
            if (document.body.contains(confetti)) {
                document.body.removeChild(confetti);
            }
        }, duration * 1000);
    }
}

// Cập nhật hàm loadData
const originalLoadData = loadData;
loadData = function() {
    originalLoadData();
    // Hiển thị cấp độ sau khi tải dữ liệu
    updateLevelDisplay();
    // Hiển thị huy hiệu
    renderBadges();
};


// Cập nhật hàm rateTask
function rateTask(childName, taskId, rating) {
    const now = new Date();
    const today = getDateKey(now);
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();

    const displayedDate = getDateKey(currentDate);
   // Tạo key duy nhất cho mỗi nhiệm vụ trong ngày
   //const taskWaterKey = `${dateKey}_${childName}_${taskId}`;
    //const taskWater = scheduleData[childName][dateKey].tasks.find(t => t.id === taskId);
   // if (!taskWater) return;
    // Kiểm tra ngày tương lai
    if (new Date(displayedDate) > new Date(today)) {
        alert("Không thể đánh giá nhiệm vụ của ngày trong tương lai!");
        return;
    }

    // Kiểm tra mật khẩu TRƯỚC KHI thực hiện bất kỳ hành động nào
    const pin = prompt("Nhập mã PIN để xác nhận (mặc định: 1234):");
    if (pin !== "1234") {
        alert("Mã PIN không đúng!");
        return;
    }

    // Chỉ thực hiện các hành động sau khi mã PIN đúng
    const dateKey = getDateKey(currentDate);
    const task = scheduleData[childName][dateKey]?.tasks.find(t => t.id === taskId);
    if (!task) return;

    task.rating = rating;
    recalculateTotalPoints(childName, dateKey);

    // Xử lý khi đánh giá tốt
    if (rating === 'good') {
        const taskTemplate = taskTemplates[childName].find(t => t.id === taskId);
        if (taskTemplate) {
            // Thứ tự: pháo hoa -> âm thanh mẹ Quỳnh -> tăng nước
            createFireworks();
            
            // Đợi pháo hoa xong mới phát âm thanh và tăng nước
            setTimeout(() => {
                playCongrats(taskTemplate.name.toLowerCase());
                addWater(1);
            }, 4000);
        }
    }

    // Cập nhật giao diện và kiểm tra thành tích
    renderTasks();
    updateProgress();
    checkReward();
    checkAndUpgradeLevel();
    checkAndAwardBadges();
    saveData();
}

// QUAN TRỌNG: Xóa hoàn toàn đoạn code này ở cuối file
// Xóa đoạn:
/*
const originalRateTask = rateTask;
rateTask = function(childName, taskId, rating) {
    ...
};
*/
function createFireworks() {
    const fireworksContainer = document.createElement('div');
    fireworksContainer.style.position = 'fixed';
    fireworksContainer.style.top = '0';
    fireworksContainer.style.left = '0';
    fireworksContainer.style.width = '100%';
    fireworksContainer.style.height = '100%';
    fireworksContainer.style.pointerEvents = 'none';
    fireworksContainer.style.zIndex = '999';
    document.body.appendChild(fireworksContainer);

    // Tạo âm thanh pháo hoa
    const audio = document.getElementById("audio-congrats");
    audio.src = "audio/firework.mp3";
    audio.play().catch(e => console.warn("Không thể phát âm thanh:", e));

    // Tăng số lượng pháo hoa và thời gian hiển thị
    const totalFireworks = 15; // Tăng từ 5 lên 15
    const duration = 8000; // Tăng từ 6000 lên 8000ms

    // Tạo pháo hoa với tần suất cao hơn
    for (let i = 0; i < totalFireworks; i++) {
        setTimeout(() => {
            createLargeFirework(fireworksContainer);
        }, i * 400); // Giảm khoảng cách giữa các quả pháo từ 800 xuống 400ms
    }

    setTimeout(() => {
        document.body.removeChild(fireworksContainer);
    }, duration);
}

function createLargeFirework(container) {
    const startX = window.innerWidth / 2;
    const startY = window.innerHeight;

    // Tăng phạm vi nổ
    const explodeX = startX + (Math.random() * 400 - 200); // Tăng từ 200 lên 400
    const explodeY = window.innerHeight * (0.2 + Math.random() * 0.4); // Nổ từ 20% đến 60% chiều cao màn hình

    const firework = document.createElement('div');
    firework.style.position = 'absolute';
    firework.style.width = '20px'; // Tăng kích thước từ 15px lên 20px
    firework.style.height = '20px';
    firework.style.borderRadius = '50%';
    firework.style.backgroundColor = getRandomColor();
    firework.style.boxShadow = `0 0 15px ${getRandomColor()}`; // Tăng độ sáng
    firework.style.left = `${startX}px`;
    firework.style.top = `${startY}px`;
    firework.style.transition = `transform 1s ease-out, opacity 1s ease-out`;
    container.appendChild(firework);

    setTimeout(() => {
        firework.style.transform = `translate(${explodeX - startX}px, ${explodeY - startY}px)`;

        setTimeout(() => {
            firework.style.opacity = '0';

            // Tăng số lượng tia và kích thước
            const numParticles = 120; // Tăng từ 80 lên 120
            for (let i = 0; i < numParticles; i++) {
                const angle = (i / numParticles) * 2 * Math.PI;
                const distance = 200 + Math.random() * 200; // Tăng khoảng cách bắn
                const duration = 2.5 + Math.random() * 1.5; // Tăng thời gian bay

                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.width = '10px'; // Tăng kích thước tia
                particle.style.height = '10px';
                particle.style.backgroundColor = getRandomColor();
                particle.style.boxShadow = `0 0 8px ${getRandomColor()}`; // Tăng độ sáng
                particle.style.opacity = '1';
                particle.style.borderRadius = '50%';
                particle.style.left = `${explodeX}px`;
                particle.style.top = `${explodeY}px`;
                particle.style.transition = `transform ${duration}s ease-out, opacity ${duration}s ease-out`;
                container.appendChild(particle);

                setTimeout(() => {
                    particle.style.transform = `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px)`;
                    particle.style.opacity = '0';
                }, 10);

                setTimeout(() => {
                    if (document.body.contains(particle)) {
                        container.removeChild(particle);
                    }
                }, duration * 1000);
            }
        }, 1000);
    }, 10);
}
function getRandomColor() {
    const colors = [
        '#ff0000', '#ffa500', '#ffff00', '#00ff00', '#00ffff', 
        '#0000ff', '#ff00ff', '#ff69b4', '#00ff7f', '#ff4500'
    ];
    return colors[Math.floor(Math.random() * colors.length)];
}

function checkAndResetTree() {
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 = Chủ nhật, 1 = Thứ 2, ...

    // Kiểm tra xem có phải là thứ 2 không
    if (dayOfWeek === 1) {
        // Lấy ngày cuối cùng reset cây từ localStorage
        const lastResetDate = localStorage.getItem('lastTreeReset');
        const today = new Date().toDateString();

        // Nếu chưa reset hôm nay
        if (lastResetDate !== today) {
            // Reset cây về cấp 1
            treeLevel = 1;
            document.getElementById("tree-img").src = "images/tree_day1.png";
            document.getElementById("tree-status").textContent = "Cây đã reset! Hãy chăm sóc cây từ đầu nhé!";
            document.getElementById("tree-status").style.color = "#FF9800";

            // Lưu ngày đã reset
            localStorage.setItem('lastTreeReset', today);
            
            // Lưu trạng thái cây
            saveData();
            
            // Thông báo cho người dùng
            alert("Đã sang tuần mới! Cây đã được reset về cấp 1.");
        }
    }
}
function createSingleFirework(container) {
    // Vị trí xuất phát
    const startX = Math.random() * window.innerWidth;
    const startY = window.innerHeight;

    // Vị trí nổ
    const explodeX = startX + (Math.random() * 200 - 100);
    const explodeY = 100 + Math.random() * (window.innerHeight / 2);

    // Tạo pháo hoa
    const firework = document.createElement('div');
    firework.style.position = 'absolute';
    firework.style.width = '8px';
    firework.style.height = '8px';
    firework.style.borderRadius = '50%';
    firework.style.backgroundColor = getRandomColor();
    firework.style.left = `${startX}px`;
    firework.style.top = `${startY}px`;
    firework.style.transition = `transform 1.5s ease-out, opacity 1.5s ease-out`;
    container.appendChild(firework);

    // Bay lên và nổ
    setTimeout(() => {
        firework.style.transform = `translate(${explodeX - startX}px, ${explodeY - startY}px)`;

        // Nổ thành nhiều tia nhỏ
        setTimeout(() => {
            firework.style.opacity = '0';

            // Tạo các tia nhỏ
            const numParticles = 50;
            for (let i = 0; i < numParticles; i++) {
                const angle = (i / numParticles) * 2 * Math.PI;
                const distance = 100 + Math.random() * 100;
                const duration = 1.5 + Math.random() * 0.5;

                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.width = '5px';
                particle.style.height = '5px';
                particle.style.backgroundColor = getRandomColor();
                particle.style.opacity = '1';
                particle.style.borderRadius = '50%';
                particle.style.left = `${explodeX}px`;
                particle.style.top = `${explodeY}px`;
                particle.style.transition = `transform ${duration}s ease-out, opacity ${duration}s ease-out`;
                container.appendChild(particle);

                // Bắn tỏa ra
                setTimeout(() => {
                    particle.style.transform = `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px)`;
                    particle.style.opacity = '0';
                }, 10);

                // Xóa tia sau khi hoàn thành
                setTimeout(() => {
                    if (document.body.contains(particle)) {
                        container.removeChild(particle);
                    }
                }, duration * 1000);
            }
        }, 1500);
    }, 10);
}
function playCongrats(taskName) {
  const messages = {
    "ăn tối tại nhà": "audio/an_toi_tai_nha.mp3",
    "vệ sinh cá nhân buổi tối": "audio/ve_sinh_ca_nhan_buoi_toi.mp3",
    "đọc sách, tô màu hoặc làm toán": "audio/doc_sach_to_mau_hoac_lam_toan.mp3",
    "đi ngủ": "audio/di_ngu.mp3",
    "thức dậy, vệ sinh cá nhân, đi học": "audio/thuc_day_ve_sinh_ca_nhan_di_hoc.mp3",
    "chơi tự do": "audio/choi_tu_do.mp3",
    "vệ sinh cá nhân sáng": "audio/ve_sinh_ca_nhan_sang.mp3",
    "ngủ đêm qua": "audio/ngu_dem_qua.mp3",
    "pháo hoa": "audio/firework.mp3"
  };

  const audio = document.getElementById("audio-congrats");
  const popup = document.getElementById("popup-congrats");
  const popupText = document.getElementById("popup-text");

  audio.src = messages[taskName] || "";
  popupText.innerText = "Chúc mừng anh Vít hoàn thành tốt nhiệm vụ: " + taskName;
  popup.style.display = "block";
  if (audio.src) {
    audio.play().catch(e => console.warn("Không thể phát audio:", e));
  }

  setTimeout(() => {
    popup.style.display = "none";
  }, 4500);
}
// Cập nhật hình ảnh cây theo ngày trong tuần


// Biến theo dõi trạng thái cây và nước
let waterCredits = 0;       // Số lượt tưới
let treeLevel = 1;          // Cấp độ cây (1-7)
let currentWeekDay = 0;     // Ngày trong tuần (0: Chủ Nhật, 1: Thứ 2...)
let waterReceivedTasks = {};
// Sửa hàm addWater để tăng số lượt tưới
// Sửa hàm addWater
function addWater(units) {
    // Tăng số lượt tưới
    waterCredits += units;
    
    // Cập nhật UI ngay lập tức
    document.getElementById("water-units").textContent = waterCredits;
    
    // Hiển thị thông báo
    const waterNotification = document.createElement("div");
    waterNotification.style.position = "fixed";
    waterNotification.style.bottom = "10px";
    waterNotification.style.left = "50%";
    waterNotification.style.transform = "translateX(-50%)";
    waterNotification.style.backgroundColor = "#2196F3";
    waterNotification.style.color = "white";
    waterNotification.style.padding = "10px 20px";
    waterNotification.style.borderRadius = "5px";
    waterNotification.style.zIndex = "9999";
    waterNotification.innerHTML = `<i class="fas fa-plus"></i> Đã thêm ${units} lượt tưới nước!`;
    
    document.body.appendChild(waterNotification);
    
    setTimeout(() => {
        waterNotification.style.opacity = "0";
        waterNotification.style.transition = "opacity 0.5s";
        setTimeout(() => {
            document.body.removeChild(waterNotification);
        }, 500);
    }, 2000);
    
    // Lưu dữ liệu
    saveData();
    
    console.log("Đã thêm", units, "lượt tưới, hiện có:", waterCredits);
}
// Cập nhật hàm rateTask
/*
const originalRateTask = rateTask;
rateTask = function(childName, taskId, rating) {
    // Gọi hàm gốc
    originalRateTask(childName, taskId, rating);

    // Nếu đánh giá tốt, tạo hiệu ứng
    if (rating === 'good') {
        const taskTemplate = taskTemplates[childName].find(t => t.id === taskId);
        if (taskTemplate) {
           playCongrats(taskTemplate.name.toLowerCase());
            addWater(1);
        }
        createFireworks(); // Gọi hiệu ứng pháo hoa
    }

    // Kiểm tra và nâng cấp
    checkAndUpgradeLevel();
    // Kiểm tra và cấp huy hiệu
    checkAndAwardBadges();
};
*/
// Sửa hàm waterTree() để debug
function waterTree() {
    console.log("Đang tưới cây, số lượt hiện tại:", waterCredits);
    
    // Debug thông báo
    if (waterCredits <= 0) {
        alert("Không đủ lượt tưới nước! Hãy hoàn thành nhiệm vụ tốt để có thêm lượt tưới.");
        return;
    }
    
    // Giảm số lượt tưới và cập nhật ngay lập tức
    waterCredits--;
    document.getElementById("water-units").textContent = waterCredits;
    
    // Hiển thị hiệu ứng tưới nước
    const wateringGif = document.getElementById("watering-gif");
    wateringGif.style.display = "block";
    
    // Cập nhật cấp độ cây
    treeLevel = Math.min(treeLevel + 1, 7);
    
    // Cập nhật hình ảnh cây sau 1.5 giây
    setTimeout(() => {
        document.getElementById("tree-img").src = `images/tree_day${treeLevel}.png`;
        wateringGif.style.display = "none";
        
        // Thông báo cho người dùng biết cây đã tăng cấp
        document.getElementById("tree-status").textContent = "Cây đã phát triển!";
        document.getElementById("tree-status").style.color = "#4CAF50";
        
        // Lưu dữ liệu
        saveData();
    }, 1500);
}

</script>
</body>
</html>